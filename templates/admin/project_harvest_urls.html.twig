{% extends 'base.html.twig' %}

{% block title %}Collecter depuis des URLs{% endblock %}

{% block body %}
    <div class="container my-4">
        <h1 class="h4 mb-3">Collecter depuis une liste d’URLs</h1>

        <div class="mb-4">
            <h2 class="h6">Sources enregistrées</h2>
            <p class="text-muted small mb-2">Placez vos fichiers dans <code>var/collect/url_lists/&lt;source&gt;/</code> (avec <code>urls.csv</code> et <code>prompt.txt</code>).</p>

            {% if sources %}
                <div class="list-group">
                    {% for source in sources %}
                        <a
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if selectedSource == source.name %}active{% endif %}"
                            href="{{ path('admin_project_harvest_urls', {source: source.name}) }}"
                        >
                            <span class="fw-semibold">{{ source.name }}</span>
                            <span class="d-flex gap-2">
                                {% if source.has_urls %}
                                    <span class="badge bg-light text-dark">urls</span>
                                {% endif %}
                                {% if source.has_prompt %}
                                    <span class="badge bg-light text-dark">prompt</span>
                                {% endif %}
                            </span>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0">Aucune source détectée.</div>
            {% endif %}
        </div>

        {% if selectedSource %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                        <h2 class="h6 mb-0">Source : {{ selectedSource }}</h2>
                        {% if sourceSummary %}
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-secondary" data-summary="total">Total {{ sourceSummary.total }}</span>
                                <span class="badge bg-warning text-dark" data-summary="pending">En attente {{ sourceSummary.pending }}</span>
                                <span class="badge bg-secondary" data-summary="queued">En file {{ sourceSummary.queued }}</span>
                                <span class="badge bg-primary" data-summary="processing">En cours {{ sourceSummary.processing }}</span>
                                <span class="badge bg-success" data-summary="done">OK {{ sourceSummary.done }}</span>
                                <span class="badge bg-info text-dark" data-summary="normalized">Normalisé {{ sourceSummary.normalized }}</span>
                                <span class="badge bg-light text-dark" data-summary="skipped">Ignoré {{ sourceSummary.skipped }}</span>
                                <span class="badge bg-danger" data-summary="error">Erreur {{ sourceSummary.error }}</span>
                            </div>
                        {% endif %}
                    </div>

                    {% if sourceError %}
                        <div class="alert alert-danger">{{ sourceError }}</div>
                    {% endif %}

                    <form method="post" action="{{ path('admin_project_harvest_urls', {source: selectedSource}) }}" id="source-run-form">
                        <input type="hidden" name="source" value="{{ selectedSource }}">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label for="source_prompt_extra" class="form-label">Complément de prompt (source)</label>
                                <textarea id="source_prompt_extra" name="source_prompt_extra" class="form-control" rows="8">{{ sourcePrompt }}</textarea>
                                <div class="form-text">Enregistré dans <code>prompt.txt</code>.</div>
                            </div>
                            <div class="col-lg-6">
                                <div class="input-group mb-3">
                                    <span class="input-group-text">Limite</span>
                                    <input type="number" class="form-control" name="batch_size" min="0" max="500" value="{{ sourceBatchSize }}" id="source-batch-size">
                                </div>
                                <div class="form-text mb-2">0 = traitement continu (sans limite).</div>
                                <div class="form-check mb-3">
                                    <input type="hidden" name="persist_source" value="0">
                                    <input class="form-check-input" type="checkbox" value="1" id="persist_source" name="persist_source" {% if persistSource %}checked{% endif %}>
                                    <label class="form-check-label" for="persist_source">
                                        Persister immédiatement (télécharge images/vidéos si présent)
                                    </label>
                                </div>
                                <div class="small text-muted mb-3" id="queue-state-label" data-queue-state="{{ queueState.paused ? 'paused' : (queueState.running ? 'running' : 'stopped') }}">
                                    File :
                                    {% if queueState.paused %}
                                        en pause
                                    {% elseif queueState.running %}
                                        en cours
                                    {% else %}
                                        arrêtée
                                    {% endif %}
                                </div>
                                {% include 'admin/_worker_status.html.twig' with {
                                    workerStatus: workerStatus,
                                    workerCommand: workerCommand
                                } %}
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="submit" name="action" value="save_source_prompt" class="btn btn-outline-secondary">Enregistrer le prompt</button>
                                    <button type="submit" name="action" value="run_source" class="btn btn-primary" id="queue-run-btn" {% if queueState.running and not queueState.paused %}disabled{% endif %}>Traiter la file</button>
                                    <button type="submit" name="action" value="pause_source" class="btn btn-outline-warning" id="queue-pause-btn" {% if queueState.paused %}disabled{% endif %}>Pause</button>
                                    <button type="submit" name="action" value="resume_source" class="btn btn-outline-success" id="queue-resume-btn" {% if not queueState.paused %}disabled{% endif %}>Reprendre</button>
                                </div>
                            </div>
                        </div>
                    </form>

                    {% if sourceEntries %}
                        {% set sourceResultsByUrl = {} %}
                        {% if sourceResults %}
                            {% for result in sourceResults %}
                                {% if result.url is defined and result.url %}
                                    {% set sourceResultsByUrl = sourceResultsByUrl|merge({(result.url): result}) %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="toggle-hide-done" checked>
                            <label class="form-check-label" for="toggle-hide-done">
                                Masquer les URLs terminées
                            </label>
                        </div>
                        <div class="table-responsive mt-4">
                            <table class="table table-sm align-middle mb-0" id="source-urls-table" data-status-url="{{ path('admin_project_harvest_urls_status', {source: selectedSource}) }}">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Progression</th>
                                        <th>Statut</th>
                                        <th>Payload</th>
                                        <th>Dernier run</th>
                                        <th>Page créée</th>
                                        <th>Dernier résultat</th>
                                        <th>JSON & debug</th>
                                        <th>Erreur</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in sourceEntries|slice(0, 200) %}
                                        {% set status = entry.status|default('pending')|lower %}
                                        {% set badgeClass = status == 'done'
                                            ? 'success'
                                            : (status == 'normalized'
                                                ? 'info text-dark'
                                                : (status == 'error'
                                                    ? 'danger'
                                                    : (status == 'processing'
                                                        ? 'primary'
                                                        : (status == 'queued'
                                                            ? 'secondary'
                                                            : (status == 'pending'
                                                                ? 'warning text-dark'
                                                                : 'secondary'))))) %}
                                        {% set runResult = sourceResultsByUrl[entry.url]|default(null) %}
                                        <tr data-status="{{ status }}" data-url="{{ entry.url }}" data-result-key="{{ entry.result_key|default('') }}" data-recent-result="{{ entry.has_result ? '1' : (runResult is not null ? '1' : '0') }}">
                                            <td class="small" data-col="url"><a href="{{ entry.url }}" target="_blank" rel="noopener noreferrer">{{ entry.url }}</a></td>
                                            <td class="small" data-col="progress">
                                                <span class="processing-indicator {{ status in ['processing','queued'] ? 'd-inline-flex' : 'd-none' }} align-items-center gap-1">
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                    <span>{{ status == 'queued' ? 'en file' : 'processing' }}</span>
                                                </span>
                                            </td>
                                            <td data-col="status"><span class="badge bg-{{ badgeClass }}">{{ status }}</span></td>
                                            <td class="small" data-col="payload">
                                                {% set payloadStatus = entry.payload_status|default('') %}
                                                {% set aiStatus = entry.ai_payload_status|default('') %}
                                                {% if payloadStatus %}
                                                    {% set payloadBadge = payloadStatus == 'ok' ? 'success' : (payloadStatus == 'weak' ? 'warning text-dark' : 'danger') %}
                                                    <span class="badge bg-{{ payloadBadge }}">{{ payloadStatus }}</span>
                                                    <div class="text-muted small">
                                                        {{ entry.payload_text_chars|default('0') }} car.,
                                                        {{ entry.payload_links|default('0') }} liens,
                                                        {{ entry.payload_images|default('0') }} images
                                                    </div>
                                                {% endif %}
                                                {% if aiStatus %}
                                                    {% set aiBadge = aiStatus == 'ok' ? 'success' : (aiStatus == 'weak' ? 'warning text-dark' : 'danger') %}
                                                    <div class="{{ payloadStatus ? 'mt-1' : '' }}">
                                                        <span class="badge bg-{{ aiBadge }}">AI {{ aiStatus }}</span>
                                                        {% if entry.ai_payload_reason is defined and entry.ai_payload_reason %}
                                                            <div class="text-muted small">{{ entry.ai_payload_reason }}</div>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                                {% if not payloadStatus and not aiStatus %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td class="small" data-col="last-run">{{ entry.last_run_at ?: '-' }}</td>
                                            <td class="small" data-col="created-url">
                                                {% if entry.created_url is defined and entry.created_url %}
                                                    <a href="{{ entry.created_url }}" target="_blank" rel="noopener noreferrer">Ouvrir</a>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td class="small" data-col="last-result">
                                                {% if runResult is not null and runResult.created is defined and runResult.created %}
                                                    <a href="{{ path('edit_show_project_presentation', {'stringId': runResult.created.stringId}) }}" target="_blank" rel="noopener noreferrer">Ouvrir</a>
                                                {% elseif runResult is not null and runResult.created_string_id is defined and runResult.created_string_id %}
                                                    <a href="{{ path('edit_show_project_presentation', {'stringId': runResult.created_string_id}) }}" target="_blank" rel="noopener noreferrer">Ouvrir</a>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td class="small" data-col="json">
                                                {% if runResult is not null and runResult.raw is defined and runResult.raw %}
                                                    <details>
                                                        <summary>JSON brut</summary>
                                                        <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ runResult.raw }}</pre>
                                                    </details>
                                                {% endif %}
                                                {% if runResult is not null and runResult.debug is defined and runResult.debug %}
                                                    <details class="mt-1">
                                                        <summary>Debug</summary>
                                                        {% if runResult.debug.final_url is defined %}
                                                            <div class="small text-muted">URL finale : {{ runResult.debug.final_url }}</div>
                                                        {% endif %}
                                                        {% if runResult.debug.links is defined %}
                                                            <div class="mt-2 small fw-bold">Liens extraits ({{ runResult.debug.links|length }})</div>
                                                            {% if runResult.debug.links %}
                                                                <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ runResult.debug.links|join('\n') }}</pre>
                                                            {% else %}
                                                                <div class="small text-muted">Aucun lien extrait.</div>
                                                            {% endif %}
                                                        {% endif %}
                                                        {% if runResult.debug.images is defined %}
                                                            <div class="mt-2 small fw-bold">Images extraites ({{ runResult.debug.images|length }})</div>
                                                            {% if runResult.debug.images %}
                                                                <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ runResult.debug.images|join('\n') }}</pre>
                                                            {% else %}
                                                                <div class="small text-muted">Aucune image extraite.</div>
                                                            {% endif %}
                                                        {% endif %}
                                                        {% if runResult.debug.logo_probe is defined %}
                                                            {% set logoProbe = runResult.debug.logo_probe %}
                                                            <div class="mt-2 small fw-bold">Logo</div>
                                                            <div class="small text-muted">
                                                                Statut : {{ logoProbe.status ?? '-' }} |
                                                                Type : {{ logoProbe.resolved_type ?? logoProbe.content_type ?? '-' }}
                                                            </div>
                                                            {% if logoProbe.final_url is defined and logoProbe.final_url %}
                                                                <div class="small text-muted">URL finale : {{ logoProbe.final_url }}</div>
                                                            {% endif %}
                                                            {% if logoProbe.error is defined and logoProbe.error %}
                                                                <div class="small text-danger">Erreur : {{ logoProbe.error }}</div>
                                                            {% endif %}
                                                            {% if runResult.debug.logo_saved is defined %}
                                                                <div class="small text-muted">
                                                                    Logo enregistré :
                                                                    {{ runResult.debug.logo_saved ? runResult.debug.logo_saved : 'non' }}
                                                                </div>
                                                            {% endif %}
                                                            {% if runResult.debug.media is defined and runResult.debug.media.logo is defined %}
                                                                {% set logoMedia = runResult.debug.media.logo %}
                                                                <div class="small text-muted">
                                                                    Téléchargé :
                                                                    {{ logoMedia.downloaded ? 'oui' : 'non' }}
                                                                    {% if logoMedia.downloaded %}
                                                                        ({{ logoMedia.mime ?? '-' }}, {{ logoMedia.size ?? 0 }} octets)
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    </details>
                                                {% endif %}
                                                {% if runResult is null or (runResult.raw is not defined and runResult.debug is not defined) %}
                                                    {% if entry.has_result is defined and entry.has_result %}
                                                        <a href="{{ path('admin_project_harvest_urls_result', {source: selectedSource, key: entry.result_key}) }}" target="_blank" rel="noopener noreferrer">Voir JSON</a>
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="small text-muted" data-col="error">{{ entry.error ?: '-' }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if sourceEntries|length > 200 %}
                            <div class="small text-muted mt-2">Affichage limité à 200 URLs ({{ sourceEntries|length }} au total).</div>
                        {% endif %}
                    {% endif %}

                    {% if sourceResults %}
                        <div class="mt-4">
                            <h3 class="h6">Dernière exécution</h3>
                            <div class="list-group">
                                {% for item in sourceResults %}
                                    <div class="list-group-item">
                                        <div class="fw-bold">{{ item.url ?? 'n/a' }}</div>
                                        {% if item.error is defined and item.error %}
                                            <div class="text-danger small">Erreur : {{ item.error }}</div>
                                        {% elseif item.created is defined and item.created %}
                                            <div class="text-success small">
                                                Créé :
                                                <a href="{{ path('edit_show_project_presentation', {'stringId': item.created.stringId}) }}" target="_blank" rel="noopener noreferrer">
                                                    {{ item.created.title ?? item.created.goal }}
                                                </a>
                                            </div>
                                        {% else %}
                                            <div class="text-muted small">Normalisation terminée (non persistée).</div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <hr class="my-4">

        <h2 class="h6 mb-3">Collecte manuelle</h2>
        <form method="post" action="{{ path('admin_project_harvest_urls') }}">
            <input type="hidden" name="action" value="manual">
            <div class="mb-3">
                <label for="prompt_extra" class="form-label">Complément de prompt</label>
                <textarea id="prompt_extra" name="prompt_extra" class="form-control" rows="8" placeholder="Optionnel : instructions supplémentaires pour la normalisation">{{ promptExtra }}</textarea>
                <div class="form-text">Ajouté au prompt standard avant l’envoi.</div>
            </div>
            <div class="mb-3">
                <label for="urls" class="form-label">Collez des URLs (une par ligne, max 10)</label>
                <textarea id="urls" name="urls" class="form-control" rows="8" placeholder="https://exemple.com/page-a&#10;https://exemple.com/page-b">{{ urls }}</textarea>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="1" id="persist" name="persist" {% if persist %}checked{% endif %}>
                <label class="form-check-label" for="persist">
                    Persister immédiatement (télécharge images/vidéos si présent)
                </label>
            </div>
            <button type="submit" class="btn btn-primary">Lancer la collecte</button>
        </form>

        {% if results %}
            <div class="mt-4">
                <h2 class="h6">Résultats</h2>
                <div class="list-group">
                    {% for item in results %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-bold">{{ item.url ?? 'n/a' }}</div>
                                    {% if item.error is defined and item.error %}
                                        <div class="text-danger small">Erreur : {{ item.error }}</div>
                                    {% elseif item.created is defined and item.created %}
                                        <div class="text-success small">
                                            Créé :
                                            <a href="{{ path('edit_show_project_presentation', {'stringId': item.created.stringId}) }}" target="_blank" rel="noopener noreferrer">
                                                {{ item.created.title ?? item.created.goal }}
                                            </a>
                                        </div>
                                    {% elseif item.created_string_id is defined and item.created_string_id %}
                                        <div class="text-success small">
                                            Créé :
                                            <a href="{{ path('edit_show_project_presentation', {'stringId': item.created_string_id}) }}" target="_blank" rel="noopener noreferrer">
                                                {{ item.created_title ?? item.created_string_id }}
                                            </a>
                                        </div>
                                    {% else %}
                                        <div class="text-muted small">Normalisation terminée (non persistée).</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if item.raw is defined and item.raw %}
                                <details class="mt-2">
                                    <summary>Voir le JSON brut</summary>
                                    <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ item.raw }}</pre>
                                </details>
                            {% endif %}
                            {% if item.debug is defined and item.debug %}
                                <details class="mt-2">
                                    <summary>Debug extraction HTML</summary>
                                    {% if item.debug.final_url is defined %}
                                        <div class="small text-muted">URL finale : {{ item.debug.final_url }}</div>
                                    {% endif %}
                                    {% if item.debug.links is defined %}
                                        <div class="mt-2 small fw-bold">Liens extraits ({{ item.debug.links|length }})</div>
                                        {% if item.debug.links %}
                                            <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ item.debug.links|join('\n') }}</pre>
                                        {% else %}
                                            <div class="small text-muted">Aucun lien extrait.</div>
                                        {% endif %}
                                    {% endif %}
                                    {% if item.debug.images is defined %}
                                        <div class="mt-2 small fw-bold">Images extraites ({{ item.debug.images|length }})</div>
                                        {% if item.debug.images %}
                                            <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ item.debug.images|join('\n') }}</pre>
                                        {% else %}
                                            <div class="small text-muted">Aucune image extraite.</div>
                                        {% endif %}
                                    {% endif %}
                                    {% if item.debug.logo_probe is defined %}
                                        {% set logoProbe = item.debug.logo_probe %}
                                        <div class="mt-2 small fw-bold">Logo</div>
                                        <div class="small text-muted">
                                            Statut : {{ logoProbe.status ?? '-' }} |
                                            Type : {{ logoProbe.resolved_type ?? logoProbe.content_type ?? '-' }}
                                        </div>
                                        {% if logoProbe.final_url is defined and logoProbe.final_url %}
                                            <div class="small text-muted">URL finale : {{ logoProbe.final_url }}</div>
                                        {% endif %}
                                        {% if logoProbe.error is defined and logoProbe.error %}
                                            <div class="small text-danger">Erreur : {{ logoProbe.error }}</div>
                                        {% endif %}
                                        {% if item.debug.logo_saved is defined %}
                                            <div class="small text-muted">
                                                Logo enregistré :
                                                {{ item.debug.logo_saved ? item.debug.logo_saved : 'non' }}
                                            </div>
                                        {% endif %}
                                        {% if item.debug.media is defined and item.debug.media.logo is defined %}
                                            {% set logoMedia = item.debug.media.logo %}
                                            <div class="small text-muted">
                                                Téléchargé :
                                                {{ logoMedia.downloaded ? 'oui' : 'non' }}
                                                {% if logoMedia.downloaded %}
                                                    ({{ logoMedia.mime ?? '-' }}, {{ logoMedia.size ?? 0 }} octets)
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                    {% if item.debug.html_preview is defined and item.debug.html_preview %}
                                        <div class="mt-2 small fw-bold">HTML (prévisualisation)</div>
                                        <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ item.debug.html_preview }}</pre>
                                    {% endif %}
                                </details>
                            {% endif %}
                            {% if item.places_debug is defined and item.places_debug %}
                                <details class="mt-2">
                                    <summary>Debug geocodage</summary>
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle mb-0">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Query</th>
                                                    <th scope="col">Status</th>
                                                    <th scope="col">Message</th>
                                                    <th scope="col">Resolved</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for debug in item.places_debug %}
                                                    <tr>
                                                        <td class="small">{{ debug.query ?? 'n/a' }}</td>
                                                        <td class="small">{{ debug.status ?? 'n/a' }}</td>
                                                        <td class="small">{{ debug.message ?? '-' }}</td>
                                                        <td class="small">
                                                            {% if debug.resolved is defined and debug.resolved %}
                                                                {{ debug.resolved.name ?? 'n/a' }}
                                                                {% if debug.resolved.lat is defined and debug.resolved.lng is defined %}
                                                                    ({{ debug.resolved.lat }}, {{ debug.resolved.lng }})
                                                                {% endif %}
                                                                {% if debug.resolved.type is defined and debug.resolved.type %}
                                                                    [{{ debug.resolved.type }}]
                                                                {% endif %}
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </details>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.getElementById('source-urls-table');
            const toggleHideDone = document.getElementById('toggle-hide-done');
            const queueLabel = document.getElementById('queue-state-label');
            const runBtn = document.getElementById('queue-run-btn');
            const pauseBtn = document.getElementById('queue-pause-btn');
            const resumeBtn = document.getElementById('queue-resume-btn');
            const workerBadge = document.querySelector('.js-worker-badge');
            const workerText = document.querySelector('.js-worker-text');
            const workerCopyBtn = document.querySelector('.js-copy-worker-command');
            const workerCopyFeedback = document.querySelector('.js-copy-worker-feedback');
            const pollDelayActive = 4000;
            let pollTimer = null;
            let pollInFlight = false;
            let queueState = queueLabel ? queueLabel.dataset.queueState : 'stopped';

            const statusClass = (status) => {
                if (status === 'done') return 'success';
                if (status === 'normalized') return 'info text-dark';
                if (status === 'error') return 'danger';
                if (status === 'processing') return 'primary';
                if (status === 'queued') return 'secondary';
                if (status === 'pending') return 'warning text-dark';
                return 'secondary';
            };

            const escapeHtml = (value) => {
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };

            const payloadClass = (status) => {
                if (status === 'ok') return 'success';
                if (status === 'weak') return 'warning text-dark';
                if (status === 'too_thin') return 'danger';
                return 'secondary';
            };

            const applyHideDone = () => {
                if (!table || !toggleHideDone) return;
                const hideDone = toggleHideDone.checked;
                const finishedStatuses = new Set(['done', 'normalized', 'skipped', 'error']);
                table.querySelectorAll('tbody tr[data-status]').forEach((row) => {
                    const status = (row.dataset.status || '').toLowerCase();
                    const shouldHide = hideDone && finishedStatuses.has(status);
                    row.classList.toggle('d-none', shouldHide);
                });
            };

            const updateQueueState = (queue) => {
                if (!queueLabel || !queue) return;
                let label = 'arrêtée';
                let state = 'stopped';
                if (queue.paused) {
                    label = 'en pause';
                    state = 'paused';
                } else if (queue.running) {
                    label = 'en cours';
                    state = 'running';
                }
                queueLabel.textContent = `File : ${label}`;
                queueLabel.dataset.queueState = state;
                queueState = state;
                if (runBtn) runBtn.disabled = queue.running && !queue.paused;
                if (pauseBtn) pauseBtn.disabled = queue.paused;
                if (resumeBtn) resumeBtn.disabled = !queue.paused;
                if (state !== 'running') {
                    stopPolling();
                }
            };

            const shouldPoll = () => {
                return document.visibilityState === 'visible' && queueState === 'running';
            };

            const stopPolling = () => {
                if (pollTimer) {
                    window.clearTimeout(pollTimer);
                    pollTimer = null;
                }
            };

            const schedulePoll = (delay) => {
                stopPolling();
                if (!shouldPoll()) return;
                pollTimer = window.setTimeout(() => refresh(true), delay);
            };

            const updateWorkerStatus = (worker) => {
                if (!worker || !workerBadge || !workerText) return;
                const active = Boolean(worker.active);
                workerBadge.classList.toggle('bg-success', active);
                workerBadge.classList.toggle('bg-secondary', !active);
                workerBadge.textContent = active ? 'Worker actif' : 'Worker inactif';
                workerBadge.dataset.workerActive = active ? '1' : '0';
                workerText.textContent = `Derniere activite : ${worker.last_seen_label || 'jamais'}`;
            };

            const bindWorkerCopy = () => {
                if (!workerCopyBtn) return;
                workerCopyBtn.addEventListener('click', async () => {
                    const command = workerCopyBtn.dataset.command || '';
                    if (!command) return;
                    let copied = false;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        try {
                            await navigator.clipboard.writeText(command);
                            copied = true;
                        } catch (e) {
                            copied = false;
                        }
                    }
                    if (!copied) {
                        const temp = document.createElement('textarea');
                        temp.value = command;
                        temp.setAttribute('readonly', 'readonly');
                        temp.style.position = 'absolute';
                        temp.style.left = '-9999px';
                        document.body.appendChild(temp);
                        temp.select();
                        copied = document.execCommand('copy');
                        document.body.removeChild(temp);
                    }
                    if (copied && workerCopyFeedback) {
                        workerCopyFeedback.classList.remove('d-none');
                        window.setTimeout(() => workerCopyFeedback.classList.add('d-none'), 1200);
                    }
                });
            };

            const updateSummary = (summary) => {
                if (!summary) return;
                document.querySelectorAll('[data-summary]').forEach((badge) => {
                    const key = badge.getAttribute('data-summary');
                    if (!key || summary[key] === undefined) return;
                    const parts = badge.textContent.split(' ');
                    parts[parts.length - 1] = summary[key];
                    badge.textContent = parts.join(' ');
                });
            };

            const updateRow = (row, entry) => {
                if (!row || !entry) return;
                const status = (entry.status || 'pending').toLowerCase();
                row.dataset.status = status;
                row.dataset.recentResult = entry.has_result ? '1' : '0';

                const statusCell = row.querySelector('[data-col="status"]');
                if (statusCell) {
                    statusCell.innerHTML = `<span class="badge bg-${statusClass(status)}">${status}</span>`;
                }

                const progressCell = row.querySelector('[data-col="progress"]');
                if (progressCell) {
                    const isActive = status === 'processing' || status === 'queued';
                    progressCell.innerHTML = isActive
                        ? '<span class="processing-indicator d-inline-flex align-items-center gap-1"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span>' + (status === 'queued' ? 'en file' : 'processing') + '</span></span>'
                        : '<span class="processing-indicator d-none align-items-center gap-1"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span>processing</span></span>';
                }

                const payloadCell = row.querySelector('[data-col="payload"]');
                if (payloadCell) {
                    const payloadStatus = entry.payload_status || '';
                    const aiStatus = entry.ai_payload_status || '';
                    const aiReason = entry.ai_payload_reason || '';
                    const parts = [];
                    if (payloadStatus) {
                        parts.push('<span class="badge bg-' + payloadClass(payloadStatus) + '">' + payloadStatus + '</span>'
                            + '<div class="text-muted small">' + (entry.payload_text_chars || 0) + ' car., ' + (entry.payload_links || 0) + ' liens, ' + (entry.payload_images || 0) + ' images</div>');
                    }
                    if (aiStatus) {
                        const aiBadge = payloadClass(aiStatus);
                        const reasonHtml = aiReason ? '<div class="text-muted small">' + escapeHtml(aiReason) + '</div>' : '';
                        parts.push('<div class="' + (payloadStatus ? 'mt-1' : '') + '"><span class="badge bg-' + aiBadge + '">AI ' + aiStatus + '</span>' + reasonHtml + '</div>');
                    }
                    payloadCell.innerHTML = parts.length ? parts.join('') : '-';
                }

                const lastRunCell = row.querySelector('[data-col="last-run"]');
                if (lastRunCell) {
                    lastRunCell.textContent = entry.last_run_at || '-';
                }

                const createdCell = row.querySelector('[data-col="created-url"]');
                if (createdCell) {
                    createdCell.innerHTML = entry.created_url
                        ? '<a href="' + entry.created_url + '" target="_blank" rel="noopener noreferrer">Ouvrir</a>'
                        : '-';
                }

                const lastResultCell = row.querySelector('[data-col="last-result"]');
                if (lastResultCell) {
                    lastResultCell.innerHTML = entry.created_url
                        ? '<a href="' + entry.created_url + '" target="_blank" rel="noopener noreferrer">Ouvrir</a>'
                        : '-';
                }

                const jsonCell = row.querySelector('[data-col="json"]');
                if (jsonCell && !jsonCell.querySelector('details')) {
                    if (entry.has_result && entry.result_key) {
                        const url = new URL(table.dataset.statusUrl, window.location.origin);
                        url.pathname = '{{ path('admin_project_harvest_urls_result') }}';
                        url.searchParams.set('source', '{{ selectedSource }}');
                        url.searchParams.set('key', entry.result_key);
                        jsonCell.innerHTML = '<a href="' + url.toString() + '" target="_blank" rel="noopener noreferrer">Voir JSON</a>';
                    } else {
                        jsonCell.textContent = '-';
                    }
                }

                const errorCell = row.querySelector('[data-col="error"]');
                if (errorCell) {
                    errorCell.textContent = entry.error || '-';
                }
            };

            const refresh = async () => {
                if (!table || !table.dataset.statusUrl) return;
                if (pollInFlight) return;
                pollInFlight = true;
                try {
                    const urls = Array.from(table.querySelectorAll('tbody tr[data-url]'))
                        .map((row) => row.dataset.url)
                        .filter((value) => value && value.length > 0);
                    const data = new FormData();
                    urls.forEach((url) => data.append('urls[]', url));
                    const response = await fetch(table.dataset.statusUrl, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: data,
                    });
                    if (!response.ok) return;
                    const payload = await response.json();
                    if (payload.queue) updateQueueState(payload.queue);
                    if (payload.summary) updateSummary(payload.summary);
                    if (payload.worker) updateWorkerStatus(payload.worker);

                    if (Array.isArray(payload.entries)) {
                        const rowMap = new Map();
                        table.querySelectorAll('tbody tr[data-url]').forEach((row) => {
                            rowMap.set(row.dataset.url, row);
                        });
                        payload.entries.forEach((entry) => {
                            const row = rowMap.get(entry.url);
                            if (row) updateRow(row, entry);
                        });
                        applyHideDone();
                    }
                } catch (e) {
                    // ignore polling errors
                } finally {
                    pollInFlight = false;
                    schedulePoll(pollDelayActive);
                }
            };

            if (toggleHideDone) {
                toggleHideDone.addEventListener('change', applyHideDone);
                applyHideDone();
            }

            if (table && table.dataset.statusUrl) {
                bindWorkerCopy();
                refresh();
                schedulePoll(pollDelayActive);
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        if (shouldPoll()) {
                            refresh();
                        }
                    } else {
                        stopPolling();
                    }
                });
            }
        });
    </script>
{% endblock %}
