{% extends 'base.html.twig' %}

{% block title %}Importer depuis Ulule{% endblock %}

{% block body %}
    <div class="container my-4">
        <h1 class="h4 mb-3">Ulule — Importer des projets</h1>

        <form method="post" action="{{ path('admin_ulule_import') }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label" for="lang">Langue</label>
                    <input id="lang" name="lang" class="form-control" value="{{ lang }}" placeholder="fr">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="country">Pays</label>
                    <input id="country" name="country" class="form-control" value="{{ country }}" placeholder="FR">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="status">Statut</label>
                    <select id="status" name="status" class="form-select">
                        <option value="currently" {% if status == 'currently' %}selected{% endif %}>En cours</option>
                        <option value="ended" {% if status == 'ended' %}selected{% endif %}>Terminé</option>
                        <option value="success" {% if status == 'success' %}selected{% endif %}>Réussi</option>
                        <option value="all" {% if status == 'all' %}selected{% endif %}>Tous</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="sort">Tri</label>
                    <select id="sort" name="sort" class="form-select">
                        <option value="new" {% if sort == 'new' %}selected{% endif %}>Nouveaux</option>
                        <option value="ending-soon" {% if sort == 'ending-soon' %}selected{% endif %}>Bientôt fini</option>
                        <option value="popular" {% if sort == 'popular' %}selected{% endif %}>Populaire</option>
                        <option value="amount" {% if sort == 'amount' %}selected{% endif %}>Montant</option>
                        <option value="position" {% if sort == 'position' %}selected{% endif %}>Position</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label" for="page_start">Page départ</label>
                    <input id="page_start" name="page_start" type="number" class="form-control" min="1" value="{{ pageStart }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="page_count">Nombre de pages</label>
                    <input id="page_count" name="page_count" type="number" class="form-control" min="1" max="10" value="{{ pageCount }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="min_description_length">Min. caractères description</label>
                    <input id="min_description_length" name="min_description_length" type="number" class="form-control" min="0" value="{{ minDescriptionLength }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="extra_query">Qualifiers supplémentaires</label>
                    <input id="extra_query" name="extra_query" class="form-control" value="{{ extraQuery }}" placeholder="tag_id:123">
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label" for="prompt_extra">Complément de prompt</label>
                        <textarea id="prompt_extra" name="prompt_extra" class="form-control" rows="5" placeholder="Optionnel : instructions supplémentaires pour la normalisation">{{ promptExtra }}</textarea>
                        <div class="form-text">Ajouté au prompt standard avant l’envoi.</div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="exclude_funded" name="exclude_funded" value="1" {% if excludeFunded %}checked{% endif %}>
                        <label class="form-check-label" for="exclude_funded">Exclure les projets déjà financés</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_video" name="include_video" value="1" {% if includeVideo %}checked{% endif %}>
                        <label class="form-check-label" for="include_video">Inclure la vidéo</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_secondary_images" name="include_secondary_images" value="1" {% if includeSecondaryImages %}checked{% endif %}>
                        <label class="form-check-label" for="include_secondary_images">Inclure les images secondaires</label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" value="1" id="persist" name="persist" {% if persist %}checked{% endif %}>
                        <label class="form-check-label" for="persist">
                            Persister immédiatement
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary mt-3">Lancer l’import</button>
        </form>

        {% if results %}
            <div class="mt-4">
                <h2 class="h6">Résumé</h2>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <span class="badge bg-secondary">Total: {{ summary.total }}</span>
                    <span class="badge bg-success">Créés: {{ summary.created }}</span>
                    <span class="badge bg-info text-dark">Normalisés: {{ summary.normalized }}</span>
                    <span class="badge bg-warning text-dark">Doublons: {{ summary.duplicates }}</span>
                    <span class="badge bg-warning text-dark">Insuffisants: {{ summary.insufficient }}</span>
                    <span class="badge bg-secondary">Ignorés: {{ summary.skipped }}</span>
                    <span class="badge bg-danger">Erreurs: {{ summary.errors }}</span>
                </div>

                <div class="list-group">
                    {% for item in results %}
                        <div class="list-group-item">
                            {% if item.error is defined and item.error %}
                                <div class="text-danger small">Erreur : {{ item.error }}</div>
                            {% endif %}

                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-bold">
                                        {{ item.name ?? 'Projet Ulule' }}
                                        {% if item.id %}<span class="text-muted">#{{ item.id }}</span>{% endif %}
                                    </div>
                                    {% if item.url %}
                                        <div class="small">
                                            <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer">{{ item.url }}</a>
                                        </div>
                                    {% endif %}
                                    {% if item.status %}
                                        <div class="small text-muted">Statut : {{ item.status }}</div>
                                    {% endif %}
                                    {% if item.reason is defined and item.reason %}
                                        <div class="small text-muted">Raison : {{ item.reason }}</div>
                                    {% endif %}
                                    {% if item.description_length is defined %}
                                        <div class="small text-muted">
                                            Description : {{ item.description_length }} caractères
                                            {% if item.description_min is defined %}(min {{ item.description_min }}){% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                {% if item.created is defined and item.created %}
                                    <div class="text-success small">
                                        Créé :
                                        <a href="{{ path('edit_show_project_presentation', {'stringId': item.created.stringId}) }}" target="_blank" rel="noopener noreferrer">
                                            {{ item.created.title ?? item.created.goal }}
                                        </a>
                                    </div>
                                {% endif %}
                            </div>

                            {% if item.input is defined and item.input %}
                                <details class="mt-2">
                                    <summary>Voir le texte structuré</summary>
                                    <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ item.input }}</pre>
                                </details>
                            {% endif %}

                            {% if item.raw is defined and item.raw %}
                                <details class="mt-2">
                                    <summary>Voir le JSON brut</summary>
                                    <pre class="theme-pre p-2 rounded" style="white-space: pre-wrap;">{{ item.raw }}</pre>
                                </details>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
