{% extends 'base.html.twig' %}

{% block title %}Suivi Ulule{% endblock %}

{% block body %}
    <div class="container my-4">
        <h1 class="h4 mb-3">Ulule — Suivi des imports</h1>

        <form id="ulule-catalog-form" method="post" action="{{ path('admin_ulule_catalog') }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label" for="lang">Langue</label>
                    <input id="lang" name="lang" class="form-control" value="{{ lang }}" placeholder="fr">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="country">Pays</label>
                    <input id="country" name="country" class="form-control" value="{{ country }}" placeholder="FR">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="status">Statut</label>
                    <select id="status" name="status" class="form-select">
                        <option value="currently" {% if status == 'currently' %}selected{% endif %}>En cours</option>
                        <option value="ended" {% if status == 'ended' %}selected{% endif %}>Terminé</option>
                        <option value="success" {% if status == 'success' %}selected{% endif %}>Réussi</option>
                        <option value="all" {% if status == 'all' %}selected{% endif %}>Tous</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="sort">Tri</label>
                    <select id="sort" name="sort" class="form-select">
                        <option value="new" {% if sort == 'new' %}selected{% endif %}>Nouveaux</option>
                        <option value="ending-soon" {% if sort == 'ending-soon' %}selected{% endif %}>Bientôt fini</option>
                        <option value="popular" {% if sort == 'popular' %}selected{% endif %}>Populaire</option>
                        <option value="amount" {% if sort == 'amount' %}selected{% endif %}>Montant</option>
                        <option value="position" {% if sort == 'position' %}selected{% endif %}>Position</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="page_start">Page départ</label>
                    <input id="page_start" name="page_start" type="number" class="form-control" min="1" value="{{ pageStart }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="page_count">Pages Ulule à charger</label>
                    <input id="page_count" name="page_count" type="number" class="form-control" min="1" max="50" value="{{ pageCount }}">
                    <div class="form-text">20 projets par page Ulule (ex: 10 pages = ~200 projets).</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="min_description_length">Min. caractères description</label>
                    <input id="min_description_length" name="min_description_length" type="number" class="form-control" min="0" value="{{ minDescriptionLength }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="extra_query">Qualifiers supplémentaires</label>
                    <input id="extra_query" name="extra_query" class="form-control" value="{{ extraQuery }}" placeholder="tag_id:123">
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-lg-6">
                    <label class="form-label" for="prompt_extra">Complément de prompt</label>
                    <textarea id="prompt_extra" name="prompt_extra" class="form-control" rows="12" placeholder="Optionnel : instructions supplémentaires pour la normalisation">{{ promptExtra }}</textarea>
                    <div class="form-text">Utilisé lors des imports manuels.</div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_video" name="include_video" value="1" {% if includeVideo %}checked{% endif %}>
                        <label class="form-check-label" for="include_video">Inclure la vidéo</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_secondary_images" name="include_secondary_images" value="1" {% if includeSecondaryImages %}checked{% endif %}>
                        <label class="form-check-label" for="include_secondary_images">Inclure les images secondaires</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="status_filter">Filtre d’état</label>
                    <select id="status_filter" name="status_filter" class="form-select">
                        <option value="pending" {% if statusFilter == 'pending' %}selected{% endif %}>À importer</option>
                        <option value="imported" {% if statusFilter == 'imported' %}selected{% endif %}>Importés</option>
                        <option value="skipped" {% if statusFilter == 'skipped' %}selected{% endif %}>Ignorés</option>
                        <option value="failed" {% if statusFilter == 'failed' %}selected{% endif %}>Échoués</option>
                        <option value="all" {% if statusFilter == 'all' %}selected{% endif %}>Tous</option>
                    </select>
                    <div class="form-check mt-2">
                        <input type="hidden" name="eligible_only" value="0">
                        <input class="form-check-input" type="checkbox" id="eligible_only" name="eligible_only" value="1" {% if eligibleOnly %}checked{% endif %}>
                        <label class="form-check-label" for="eligible_only">Afficher uniquement les projets éligibles</label>
                    </div>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 mt-3">
                <button type="submit" class="btn btn-primary">Actualiser la liste</button>
                <button type="submit" class="btn btn-outline-secondary" name="save_prompt" value="1">Enregistrer le complément de prompt</button>
                <button type="button" class="btn btn-outline-primary" id="ulule-load-more">Charger 200 suivants</button>
                <span class="small text-muted">Ajoute 10 pages Ulule de plus à la requête.</span>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <div>
                            <div class="fw-semibold">File d’import Ulule</div>
                            <div class="small text-muted d-inline-flex align-items-center" id="ulule-queue-state" data-queue-state="{{ ululeQueueState.paused ? 'paused' : (ululeQueueState.running ? 'running' : 'stopped') }}">
                                <span id="ulule-queue-text">
                                {% if ululeQueueState.paused %}
                                    File : en pause
                                {% elseif ululeQueueState.running %}
                                    File : en cours
                                {% else %}
                                    File : arrêtée
                                {% endif %}
                                </span>
                                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true" id="ulule-queue-spinner"></span>
                            </div>
                            <div class="mt-2">
                                {% include 'admin/_worker_status.html.twig' with {
                                    workerStatus: workerStatus,
                                    workerCommand: workerCommand
                                } %}
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <div class="input-group input-group-sm" style="max-width: 170px;">
                                <span class="input-group-text">Limite</span>
                                <input type="number" class="form-control" name="batch_size" min="0" max="500" value="0">
                            </div>
                            <span class="small text-muted">0 = traitement continu.</span>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button type="submit" class="btn btn-primary" formaction="{{ path('admin_ulule_queue_start') }}" id="ulule-queue-run" data-queue-action="start" {% if ululeQueueState.running and not ululeQueueState.paused %}disabled{% endif %}>Traiter la file</button>
                        <button type="submit" class="btn btn-outline-warning" formaction="{{ path('admin_ulule_queue_pause') }}" id="ulule-queue-pause" data-queue-action="pause" {% if ululeQueueState.paused %}disabled{% endif %}>Pause</button>
                        <button type="submit" class="btn btn-outline-success" formaction="{{ path('admin_ulule_queue_resume') }}" id="ulule-queue-resume" data-queue-action="resume" {% if not ululeQueueState.paused %}disabled{% endif %}>Reprendre</button>
                    </div>
                </div>
            </div>
        </form>

        {% if refreshSummary %}
            <div class="alert alert-info mt-3">
                Ulule rafraîchi : {{ refreshSummary.updated }} projets sur {{ refreshSummary.total }} ({{ refreshSummary.errors }} erreur{{ refreshSummary.errors > 1 ? 's' : '' }}).
            </div>
        {% endif %}

        <div class="mt-4">
            <h2 class="h6">Résumé</h2>
            <div class="d-flex flex-wrap gap-2 mb-3">
                <span class="badge bg-warning text-dark" data-summary="pending">À importer: {{ statusCounts.pending ?? 0 }}</span>
                <span class="badge bg-success" data-summary="imported">Importés: {{ statusCounts.imported ?? 0 }}</span>
                <span class="badge bg-secondary" data-summary="skipped">Ignorés: {{ statusCounts.skipped ?? 0 }}</span>
                <span class="badge bg-danger" data-summary="failed">Échoués: {{ statusCounts.failed ?? 0 }}</span>
            </div>

            <div class="table-responsive">
                <table class="table table-sm align-middle" id="ulule-catalog-table" data-status-url="{{ path('admin_ulule_queue_status', {
                    status_filter: statusFilter,
                    eligible_only: eligibleOnly ? 1 : 0,
                    min_description_length: minDescriptionLength,
                    exclude_funded: excludeFunded ? 1 : 0
                }) }}">
                    <thead>
                        <tr>
                            <th scope="col">Projet</th>
                            <th scope="col">Progression</th>
                            <th scope="col">Ajout Ulule</th>
                            <th scope="col">Données</th>
                            <th scope="col">État</th>
                            <th scope="col">Import</th>
                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                            {% set importStatus = item.importStatus ?? 'pending' %}
                            {% set statusClass = {
                                'pending': 'bg-warning text-dark',
                                'imported': 'bg-success',
                                'skipped': 'bg-secondary',
                                'failed': 'bg-danger'
                            }[importStatus]|default('bg-secondary') %}
                            {% set eligible = (
                                (importStatus != 'imported')
                                and (importStatus != 'skipped')
                                and (not excludeFunded or not item.goalRaised)
                                and (item.isCancelled is not true)
                                and (item.isOnline is not same as(false))
                                and (item.descriptionLength is not null)
                                and (item.descriptionLength >= minDescriptionLength)
                            ) %}
                            <tr data-ulule-id="{{ item.ululeId }}">
                                <td>
                                    <div class="fw-bold">
                                        {{ item.name ?? 'Projet Ulule' }}
                                        <span class="text-muted">#{{ item.ululeId }}</span>
                                    </div>
                                    {% if item.sourceUrl %}
                                        <div class="small">
                                            <a href="{{ item.sourceUrl }}" target="_blank" rel="noopener noreferrer">{{ item.sourceUrl }}</a>
                                        </div>
                                    {% endif %}
                                    {% if item.subtitle %}
                                        <div class="small text-muted">{{ item.subtitle }}</div>
                                    {% endif %}
                                </td>
                                <td class="small" data-col="progress">
                                    <span class="processing-indicator {{ ululeQueueState.running and ululeQueueState.current_id == item.ululeId ? 'd-inline-flex' : 'd-none' }} align-items-center gap-1">
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <span>en cours</span>
                                    </span>
                                </td>
                                <td class="small text-muted">
                                    {% if item.ululeCreatedAt %}
                                        <div>{{ item.ululeCreatedAt|date('Y-m-d') }}</div>
                                        <div class="small text-muted">{{ ululeCreatedLabels[item.ululeId] ?? '' }}</div>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="small text-muted">
                                    <div>Langue : {{ item.lang ?? 'n/a' }} | Pays : {{ item.country ?? 'n/a' }}</div>
                                    <div>Type : {{ item.type ?? 'n/a' }}</div>
                                    <div>Vu : {{ lastSeenLabels[item.ululeId] ?? 'n/a' }}</div>
                                    {% if lastImportedLabels[item.ululeId] is defined and lastImportedLabels[item.ululeId] %}
                                        <div>Importé : {{ lastImportedLabels[item.ululeId] }}</div>
                                    {% endif %}
                                    <div>
                                        Description :
                                        {% if item.descriptionLength is not null %}
                                            {{ item.descriptionLength }} caractères (min {{ minDescriptionLength }})
                                        {% else %}
                                            n/a
                                        {% endif %}
                                    </div>
                                    <div>
                                        Financé : {{ item.goalRaised ? 'oui' : 'non' }}
                                        | En ligne : {{ item.isOnline is same as(false) ? 'non' : 'oui' }}
                                        | Annulé : {{ item.isCancelled ? 'oui' : 'non' }}
                                    </div>
                                </td>
                                <td data-col="status">
                                    <span class="badge {{ statusClass }}">{{ importStatus }}</span>
                                    <span class="badge bg-light text-muted {{ eligible ? 'd-none' : '' }}" data-col="eligible">non éligible</span>
                                    {% if item.importStatusComment %}
                                        <div class="small text-muted mt-1" data-col="status-comment">{{ item.importStatusComment }}</div>
                                    {% else %}
                                        <div class="small text-muted mt-1 d-none" data-col="status-comment"></div>
                                    {% endif %}
                                    {% if item.lastError %}
                                        <div class="small text-danger mt-1" data-col="status-error">{{ item.lastError }}</div>
                                    {% else %}
                                        <div class="small text-danger mt-1 d-none" data-col="status-error"></div>
                                    {% endif %}
                                </td>
                                <td class="small text-muted" data-col="import-link">
                                    {% if item.importedStringId %}
                                        <a href="{{ path('edit_show_project_presentation', {'stringId': item.importedStringId}) }}" target="_blank" rel="noopener noreferrer">
                                            Voir la fiche
                                        </a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button
                                        type="submit"
                                        class="btn btn-sm btn-primary"
                                        form="ulule-catalog-form"
                                        formmethod="post"
                                        formaction="{{ path('admin_ulule_import_project', {'ululeId': item.ululeId}) }}"
                                        {% if not eligible %}disabled{% endif %}
                                    >
                                        Importer
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-primary js-ulule-preview"
                                        data-ulule-id="{{ item.ululeId }}"
                                    >
                                        Prévisualiser
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-success js-ulule-import-open"
                                        data-ulule-id="{{ item.ululeId }}"
                                        {% if not eligible %}disabled{% endif %}
                                    >
                                        Importer + ouvrir
                                    </button>
                                    <form method="post" action="{{ path('admin_ulule_catalog_status', {'ululeId': item.ululeId}) }}" class="d-inline">
                                        <input type="hidden" name="status" value="skipped">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">Ignorer</button>
                                    </form>
                                    <form method="post" action="{{ path('admin_ulule_catalog_status', {'ululeId': item.ululeId}) }}" class="d-inline">
                                        <input type="hidden" name="status" value="pending">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">Réinitialiser</button>
                                    </form>
                                    <div class="small text-muted js-ulule-import-status mt-1"></div>
                                </td>
                            </tr>
                            <tr id="ulule-preview-row-{{ item.ululeId }}" class="d-none">
                                <td colspan="7">
                                    <div class="ulule-preview-content small"></div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-muted">Aucun projet trouvé.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('ulule-catalog-form');
            if (!form) {
                return;
            }

            const table = document.getElementById('ulule-catalog-table');
            const queueLabel = document.getElementById('ulule-queue-state');
            const queueText = document.getElementById('ulule-queue-text');
            const queueSpinner = document.getElementById('ulule-queue-spinner');
            const queueRunBtn = document.getElementById('ulule-queue-run');
            const queuePauseBtn = document.getElementById('ulule-queue-pause');
            const queueResumeBtn = document.getElementById('ulule-queue-resume');
            const workerBadge = document.querySelector('.js-worker-badge');
            const workerText = document.querySelector('.js-worker-text');
            const workerCopyBtn = document.querySelector('.js-copy-worker-command');
            const workerCopyFeedback = document.querySelector('.js-copy-worker-feedback');
            const loadMoreBtn = document.getElementById('ulule-load-more');
            const previewButtons = document.querySelectorAll('.js-ulule-preview');
            const importButtons = document.querySelectorAll('.js-ulule-import-open');
            const queueButtons = document.querySelectorAll('[data-queue-action]');
            const importUrlTemplate = `{{ path('admin_ulule_import_project', {'ululeId': 'ULULE_ID'}) }}`;

            const statusClass = (status) => {
                if (status === 'pending') return 'bg-warning text-dark';
                if (status === 'imported') return 'bg-success';
                if (status === 'skipped') return 'bg-secondary';
                if (status === 'failed') return 'bg-danger';
                return 'bg-secondary';
            };

            const updateQueueState = (queue) => {
                if (!queueLabel || !queue) return;
                let label = 'arrêtée';
                let state = 'stopped';
                if (queue.paused) {
                    label = 'en pause';
                    state = 'paused';
                } else if (queue.running) {
                    label = 'en cours';
                    state = 'running';
                }
                if (queueText) {
                    queueText.textContent = `File : ${label}`;
                }
                queueLabel.dataset.queueState = state;
                if (queueRunBtn) queueRunBtn.disabled = queue.running && !queue.paused;
                if (queuePauseBtn) queuePauseBtn.disabled = queue.paused;
                if (queueResumeBtn) queueResumeBtn.disabled = !queue.paused;
                if (queueSpinner) {
                    queueSpinner.classList.toggle('d-none', state !== 'running');
                }
            };

            const updateSummary = (summary) => {
                if (!summary) return;
                document.querySelectorAll('[data-summary]').forEach((badge) => {
                    const key = badge.getAttribute('data-summary');
                    if (!key || summary[key] === undefined) return;
                    const parts = badge.textContent.split(' ');
                    parts[parts.length - 1] = summary[key];
                    badge.textContent = parts.join(' ');
                });
            };

            const updateWorkerStatus = (worker) => {
                if (!worker || !workerBadge || !workerText) return;
                const active = Boolean(worker.active);
                workerBadge.classList.toggle('bg-success', active);
                workerBadge.classList.toggle('bg-secondary', !active);
                workerBadge.textContent = active ? 'Worker actif' : 'Worker inactif';
                workerBadge.dataset.workerActive = active ? '1' : '0';
                workerText.textContent = `Derniere activite : ${worker.last_seen_label || 'jamais'}`;
            };

            const bindWorkerCopy = () => {
                if (!workerCopyBtn) return;
                workerCopyBtn.addEventListener('click', async () => {
                    const command = workerCopyBtn.dataset.command || '';
                    if (!command) return;
                    let copied = false;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        try {
                            await navigator.clipboard.writeText(command);
                            copied = true;
                        } catch (e) {
                            copied = false;
                        }
                    }
                    if (!copied) {
                        const temp = document.createElement('textarea');
                        temp.value = command;
                        temp.setAttribute('readonly', 'readonly');
                        temp.style.position = 'absolute';
                        temp.style.left = '-9999px';
                        document.body.appendChild(temp);
                        temp.select();
                        copied = document.execCommand('copy');
                        document.body.removeChild(temp);
                    }
                    if (copied && workerCopyFeedback) {
                        workerCopyFeedback.classList.remove('d-none');
                        window.setTimeout(() => workerCopyFeedback.classList.add('d-none'), 1200);
                    }
                });
            };

            const updateRow = (row, item, queue) => {
                if (!row || !item) return;
                const status = (item.import_status || 'pending').toLowerCase();
                const statusCell = row.querySelector('[data-col="status"]');
                if (statusCell) {
                    const badge = statusCell.querySelector('.badge');
                    if (badge) {
                        badge.className = `badge ${statusClass(status)}`;
                        badge.textContent = status;
                    }
                    const eligibleBadge = statusCell.querySelector('[data-col="eligible"]');
                    if (eligibleBadge) {
                        eligibleBadge.classList.toggle('d-none', item.eligible);
                    }
                    const comment = statusCell.querySelector('[data-col="status-comment"]');
                    if (comment) {
                        if (item.import_status_comment) {
                            comment.textContent = item.import_status_comment;
                            comment.classList.remove('d-none');
                        } else {
                            comment.textContent = '';
                            comment.classList.add('d-none');
                        }
                    }
                    const error = statusCell.querySelector('[data-col="status-error"]');
                    if (error) {
                        if (item.last_error) {
                            error.textContent = item.last_error;
                            error.classList.remove('d-none');
                        } else {
                            error.textContent = '';
                            error.classList.add('d-none');
                        }
                    }
                }

                const linkCell = row.querySelector('[data-col="import-link"]');
                if (linkCell) {
                    linkCell.innerHTML = item.created_url
                        ? `<a href="${item.created_url}" target="_blank" rel="noopener noreferrer">Voir la fiche</a>`
                        : '-';
                }

                const progressCell = row.querySelector('[data-col="progress"]');
                if (progressCell) {
                    const isActive = queue && queue.running && String(queue.current_id) === String(item.id);
                    const indicator = progressCell.querySelector('.processing-indicator');
                    if (indicator) {
                        indicator.classList.toggle('d-none', !isActive);
                        indicator.classList.toggle('d-inline-flex', isActive);
                    }
                }
            };

            const refreshStatus = async () => {
                if (!table || !table.dataset.statusUrl) return;
                const baseStatusUrl = table.dataset.statusUrl;
                const ids = Array.from(table.querySelectorAll('tbody tr[data-ulule-id]'))
                    .map((row) => row.dataset.ululeId)
                    .filter((id) => id && id.length > 0)
                    .join(',');
                let statusUrl = baseStatusUrl;
                if (ids.length > 0) {
                    const separator = baseStatusUrl.includes('?') ? '&' : '?';
                    statusUrl = `${baseStatusUrl}${separator}ids=${encodeURIComponent(ids)}`;
                }
                try {
                    const response = await fetch(statusUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (!response.ok) return;
                    const data = await response.json();
                    if (data.queue) updateQueueState(data.queue);
                    if (data.summary) updateSummary(data.summary);
                    if (data.worker) updateWorkerStatus(data.worker);
                    if (Array.isArray(data.items)) {
                        const rowMap = new Map();
                        table.querySelectorAll('tbody tr[data-ulule-id]').forEach((row) => {
                            rowMap.set(row.dataset.ululeId, row);
                        });
                        data.items.forEach((item) => {
                            const row = rowMap.get(String(item.id));
                            if (row) updateRow(row, item, data.queue);
                        });
                    }
                } catch (e) {
                    // ignore polling errors
                }
            };

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    const pageStartInput = form.querySelector('#page_start');
                    const pageCountInput = form.querySelector('#page_count');
                    if (!pageStartInput || !pageCountInput) {
                        form.submit();
                        return;
                    }
                    const pageStart = parseInt(pageStartInput.value || '1', 10) || 1;
                    const pageCount = parseInt(pageCountInput.value || '50', 10) || 50;
                    pageStartInput.value = `${pageStart + pageCount}`;
                    form.submit();
                });
            }

            queueButtons.forEach((button) => {
                button.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const actionUrl = button.getAttribute('formaction');
                    if (!actionUrl) {
                        form.submit();
                        return;
                    }

                    if (queueText) {
                        queueText.textContent = button.dataset.queueAction === 'pause'
                            ? 'File : mise en pause...'
                            : 'File : démarrage...';
                    }
                    if (queueSpinner) {
                        queueSpinner.classList.remove('d-none');
                    }

                    const data = new FormData(form);
                    button.disabled = true;
                    try {
                        const response = await fetch(actionUrl, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' },
                            body: data,
                        });
                        if (!response.ok) {
                            if (queueText) {
                                queueText.textContent = 'File : erreur de démarrage';
                            }
                        }
                        await refreshStatus();
                    } catch (error) {
                        if (queueText) {
                            queueText.textContent = 'File : erreur réseau';
                        }
                    } finally {
                        button.disabled = false;
                        if (queueSpinner) {
                            queueSpinner.classList.add('d-none');
                        }
                    }
                });
            });
            previewButtons.forEach((button) => {
                button.addEventListener('click', async () => {
                    const ululeId = button.dataset.ululeId;
                    if (!ululeId) {
                        return;
                    }
                    const row = document.getElementById(`ulule-preview-row-${ululeId}`);
                    if (!row) {
                        return;
                    }
                    const content = row.querySelector('.ulule-preview-content');
                    if (!content) {
                        return;
                    }

                    if (!row.classList.contains('d-none') && row.dataset.loaded === '1') {
                        row.classList.add('d-none');
                        return;
                    }

                    row.classList.remove('d-none');
                    if (row.dataset.loaded === '1') {
                        return;
                    }

                    content.textContent = 'Chargement...';
                    const data = new FormData(form);

                    try {
                        const response = await fetch(`{{ path('admin_ulule_import_project_preview', {'ululeId': 'ULULE_ID'}) }}`.replace('ULULE_ID', ululeId), {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' },
                            body: data,
                        });
                        const payload = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            content.textContent = payload.error || `Erreur (${response.status}).`;
                            return;
                        }

                        content.innerHTML = '';

                        const statusLine = document.createElement('div');
                        statusLine.className = 'mb-2';
                        const statusLabel = payload.status ? `Statut : ${payload.status}` : 'Statut : n/a';
                        statusLine.textContent = statusLabel;
                        content.appendChild(statusLine);

                        if (payload.reason) {
                            const reasonLine = document.createElement('div');
                            reasonLine.className = 'mb-2 text-muted';
                            reasonLine.textContent = `Raison : ${payload.reason}`;
                            content.appendChild(reasonLine);
                        }

                        if (payload.error) {
                            const errorLine = document.createElement('div');
                            errorLine.className = 'mb-2 text-danger';
                            errorLine.textContent = `Erreur : ${payload.error}`;
                            content.appendChild(errorLine);
                        }

                        if (payload.input) {
                            const details = document.createElement('details');
                            details.className = 'mt-2';
                            const summary = document.createElement('summary');
                            summary.textContent = 'Voir le texte structuré';
                            const pre = document.createElement('pre');
                            pre.className = 'theme-pre p-2 rounded';
                            pre.style.whiteSpace = 'pre-wrap';
                            pre.textContent = payload.input;
                            details.appendChild(summary);
                            details.appendChild(pre);
                            content.appendChild(details);
                        }

                        if (payload.raw) {
                            const details = document.createElement('details');
                            details.className = 'mt-2';
                            const summary = document.createElement('summary');
                            summary.textContent = 'Voir le JSON brut (IA)';
                            const pre = document.createElement('pre');
                            pre.className = 'theme-pre p-2 rounded';
                            pre.style.whiteSpace = 'pre-wrap';
                            pre.textContent = payload.raw;
                            details.appendChild(summary);
                            details.appendChild(pre);
                            content.appendChild(details);
                        }

                        if (payload.enriched) {
                            const details = document.createElement('details');
                            details.className = 'mt-2';
                            const summary = document.createElement('summary');
                            summary.textContent = 'Voir le JSON enrichi (persisté)';
                            const pre = document.createElement('pre');
                            pre.className = 'theme-pre p-2 rounded';
                            pre.style.whiteSpace = 'pre-wrap';
                            pre.textContent = JSON.stringify(payload.enriched, null, 2);
                            details.appendChild(summary);
                            details.appendChild(pre);
                            content.appendChild(details);
                        }

                        row.dataset.loaded = '1';
                    } catch (error) {
                        content.textContent = 'Erreur réseau pendant la prévisualisation.';
                    }
                });
            });

            importButtons.forEach((button) => {
                button.addEventListener('click', async () => {
                    const ululeId = button.dataset.ululeId;
                    if (!ululeId) {
                        return;
                    }
                    const statusEl = button.closest('td')?.querySelector('.js-ulule-import-status');
                    if (statusEl) {
                        statusEl.textContent = 'Import en cours...';
                    }

                    const targetWindow = window.open('about:blank', '_blank');
                    const data = new FormData(form);

                    button.disabled = true;
                    try {
                        const response = await fetch(importUrlTemplate.replace('ULULE_ID', ululeId), {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' },
                            body: data,
                        });
                        const payload = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            if (statusEl) {
                                statusEl.textContent = payload.message || `Erreur (${response.status}).`;
                            }
                            if (targetWindow) {
                                targetWindow.close();
                            }
                            return;
                        }

                        if (payload.created_url) {
                            if (targetWindow) {
                                targetWindow.location = payload.created_url;
                            } else {
                                window.open(payload.created_url, '_blank');
                            }
                            if (statusEl) {
                                statusEl.textContent = payload.message || 'Import terminé.';
                            }
                        } else {
                            if (targetWindow) {
                                targetWindow.close();
                            }
                            if (statusEl) {
                                statusEl.textContent = payload.message || 'Import terminé (sans lien).';
                            }
                        }
                    } catch (error) {
                        if (targetWindow) {
                            targetWindow.close();
                        }
                        if (statusEl) {
                            statusEl.textContent = 'Erreur réseau pendant l’import.';
                        }
                    } finally {
                        button.disabled = false;
                    }
                });
            });

            if (table && table.dataset.statusUrl) {
                bindWorkerCopy();
                refreshStatus();
                setInterval(refreshStatus, 4000);
            }
        });
    </script>
{% endblock %}
