{% extends 'base.html.twig' %}

{% block title %}Monitoring{% endblock %}

{% block body %}
<div class="container my-4 monitoring-dashboard">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div>
            <h1 class="h4 mb-1">Monitoring Propon</h1>
            <div class="text-muted small">Vue synthétique de l’activité et de la croissance.</div>
        </div>
        <form method="get" action="{{ path('admin_monitoring') }}" class="monitoring-filter d-flex flex-wrap align-items-end gap-2">
            <div>
                <label class="form-label small mb-1" for="range">Période</label>
                <select id="range" name="range" class="form-select form-select-sm">
                    <option value="7d" {{ rangeKey == '7d' ? 'selected' }}>7 jours</option>
                    <option value="30d" {{ rangeKey == '30d' ? 'selected' }}>30 jours</option>
                    <option value="90d" {{ rangeKey == '90d' ? 'selected' }}>90 jours</option>
                    <option value="365d" {{ rangeKey == '365d' ? 'selected' }}>12 mois</option>
                    <option value="custom" {{ rangeKey == 'custom' ? 'selected' }}>Personnalisé</option>
                </select>
            </div>
            <div>
                <label class="form-label small mb-1" for="start">Début</label>
                <input id="start" name="start" type="date" class="form-control form-control-sm" value="{{ rangeStart|date('Y-m-d') }}">
            </div>
            <div>
                <label class="form-label small mb-1" for="end">Fin</label>
                <input id="end" name="end" type="date" class="form-control form-control-sm" value="{{ rangeEnd|date('Y-m-d') }}">
            </div>
            <div class="align-self-end">
                <button type="submit" class="btn btn-sm btn-primary" formaction="{{ path('admin_monitoring') }}">Appliquer</button>
            </div>
        </form>
    </div>

    <div class="kpi-grid mb-4">
        <div class="kpi-card">
            <div class="kpi-label">Utilisateurs</div>
            <div class="kpi-value">{{ stats.usersTotal }}</div>
            <div class="kpi-sub">+{{ stats.newUsers }} sur la période</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Présentations</div>
            <div class="kpi-value">{{ stats.projectsTotal }}</div>
            <div class="kpi-sub">+{{ stats.newProjects }} sur la période</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Commentaires</div>
            <div class="kpi-value">{{ stats.commentsTotal }}</div>
            <div class="kpi-sub">+{{ stats.newComments }} sur la période</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Actualités</div>
            <div class="kpi-value">{{ stats.newsTotal }}</div>
            <div class="kpi-sub">+{{ stats.newNews }} sur la période</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Vues 3P</div>
            <div class="kpi-value">{{ stats.viewsTotal }}</div>
            <div class="kpi-sub">{{ stats.distinctVisitors }} visiteurs uniques, {{ stats.returningVisitors }} récurrents</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Partages</div>
            <div class="kpi-value">{{ stats.sharesTotal }}</div>
            <div class="kpi-sub">+{{ stats.newLikes }} likes · +{{ stats.newFollows }} follows</div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Utilisateurs & présentations</h2>
                    <canvas class="js-line-chart" height="180"
                            data-labels='{{ dateLabels|json_encode|raw }}'
                            data-series='{{ [
                                {label: "Utilisateurs", data: series.users, color: "#2b7de9"},
                                {label: "Présentations manuelles", data: series.projectsManual, color: "#1e9e6a"},
                                {label: "Présentations automatisées", data: series.projectsAutomated, color: "#f5a623"}
                            ]|json_encode|raw }}'></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Engagement</h2>
                    <canvas class="js-line-chart" height="180"
                            data-labels='{{ dateLabels|json_encode|raw }}'
                            data-series='{{ [
                                {label: "Commentaires", data: series.comments, color: "#7b61ff"},
                                {label: "Likes", data: series.likes, color: "#e6506d"},
                                {label: "Follows", data: series.follows, color: "#3b82f6"},
                                {label: "Partages", data: series.shares, color: "#6b7280"}
                            ]|json_encode|raw }}'></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Trafic</h2>
                    <canvas class="js-line-chart" height="180"
                            data-labels='{{ dateLabels|json_encode|raw }}'
                            data-series='{{ [
                                {label: "Vues 3P", data: series.views, color: "#0ea5e9"}
                            ]|json_encode|raw }}'></canvas>
                </div>
            </div>
        </div>
    </div>

    {% set homeFeedBlockLabels = {
        'neighbor-affinity': 'Parce que vous avez consulté',
        'anon-neighbor-affinity': 'Parce que vous avez consulté (anon)',
        'category-affinity': 'Basé sur vos catégories',
        'anon-category-affinity': 'Selon vos centres d’intérêt récents',
        'domain-interest': 'Domaines d’intérêt',
        'anon-domain-interest': 'Domaines d’intérêt (anon)',
        'around-you': 'Autour de vous',
        'followed-projects': 'Projets suivis',
        'trending': 'Tendance sur Propon',
        'latest': 'Derniers projets présentés'
    } %}

    <div class="row g-3 mb-4">
        <div class="col-lg-12">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">CTR des rails homepage</h2>
                    <div class="text-muted small mb-2">Impressions et clics des cartes par bloc (période sélectionnée).</div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Bloc</th>
                                    <th scope="col">Clé</th>
                                    <th scope="col" class="text-end">Impressions</th>
                                    <th scope="col" class="text-end">Clics</th>
                                    <th scope="col" class="text-end">CTR</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in homeFeedMetrics %}
                                    <tr>
                                        <td>{{ homeFeedBlockLabels[row.block]|default(row.block) }}</td>
                                        <td><code>{{ row.block }}</code></td>
                                        <td class="text-end">{{ row.impressions }}</td>
                                        <td class="text-end">{{ row.clicks }}</td>
                                        <td class="text-end">{{ row.ctr|number_format(2, ',', ' ') }}%</td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-muted">Pas encore de données pour les rails homepage.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Répartition par catégorie</h2>
                    <div class="category-grid">
                        {% for category in categories %}
                            <div class="category-row">
                                <div class="category-label">
                                    <img class="category-icon" src="{{ asset('project_categories/' ~ category.uniqueName ~ '.svg', 'icons') }}" alt="{{ category.label }}">
                                    <span>{{ category.label ?? category.uniqueName }}</span>
                                </div>
                                <div class="category-bar">
                                    <span style="--category-width: {{ categories[0].total > 0 ? (category.total / categories[0].total * 100) : 0 }}%"></span>
                                </div>
                                <div class="category-count">{{ category.total }}</div>
                            </div>
                        {% else %}
                            <div class="text-muted">Aucune catégorie.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Statuts des présentations</h2>
                    <div class="status-grid">
                        <div class="status-item">
                            <span>Publiées</span>
                            <strong>{{ stats.projectsPublished }}</strong>
                        </div>
                        <div class="status-item">
                            <span>Non publiées</span>
                            <strong>{{ stats.projectsUnpublished }}</strong>
                        </div>
                        <div class="status-item">
                            <span>Supprimées</span>
                            <strong>{{ stats.projectsDeleted }}</strong>
                        </div>
                        <div class="status-item">
                            <span>Manuelles</span>
                            <strong>{{ stats.projectsManual }}</strong>
                        </div>
                        <div class="status-item">
                            <span>Automatisées</span>
                            <strong>{{ stats.projectsAutomated }}</strong>
                        </div>
                    </div>
                    <div class="text-muted small mt-2">Les données automatisées correspondent aux présentations avec source URL.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Derniers utilisateurs</h2>
                    <ul class="list-group list-group-flush">
                        {% for user in latestUsers %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ user.username ?? user.email ?? 'Utilisateur' }}</span>
                                <span class="text-muted small">{{ user.createdAt|date('d/m/Y') }}</span>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">Aucun utilisateur.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Dernières présentations</h2>
                    <ul class="list-group list-group-flush">
                        {% for pp in latestProjects %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    <a href="{{ path('edit_show_project_presentation', {'stringId': pp.stringId}) }}" target="_blank" rel="noopener">{{ pp.title ?? pp.goal ?? 'Présentation' }}</a>
                                    {% if pp.ingestion.sourceUrl %}
                                        <span class="badge text-bg-secondary ms-1">Auto</span>
                                    {% else %}
                                        <span class="badge text-bg-success ms-1">Manuel</span>
                                    {% endif %}
                                </span>
                                <span class="text-muted small">{{ pp.createdAt|date('d/m/Y') }}</span>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">Aucune présentation.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Derniers commentaires</h2>
                    <ul class="list-group list-group-flush">
                        {% for comment in latestComments %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ comment.content|striptags|truncate(60) }}</span>
                                <span class="text-muted small">{{ comment.createdAt|date('d/m/Y') }}</span>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">Aucun commentaire.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6">Dernières actualités</h2>
                    <ul class="list-group list-group-flush">
                        {% for item in latestNews %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ item.textContent|striptags|truncate(60) }}</span>
                                <span class="text-muted small">{{ item.createdAt|date('d/m/Y') }}</span>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">Aucune actualité.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function drawLineChart(canvas, labels, series) {
        var ctx = canvas.getContext('2d');
        if (!ctx) {
            return;
        }
        var ratio = window.devicePixelRatio || 1;
        var width = canvas.clientWidth || 600;
        var height = canvas.height || 180;
        canvas.width = width * ratio;
        canvas.height = height * ratio;
        ctx.scale(ratio, ratio);

        var padding = { top: 16, right: 12, bottom: 24, left: 40 };
        var chartWidth = width - padding.left - padding.right;
        var chartHeight = height - padding.top - padding.bottom;

        var maxValue = 0;
        series.forEach(function (s) {
            s.data.forEach(function (v) {
                if (v > maxValue) {
                    maxValue = v;
                }
            });
        });
        if (maxValue === 0) {
            maxValue = 1;
        }

        ctx.clearRect(0, 0, width, height);
        ctx.strokeStyle = 'rgba(120,120,120,0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top);
        ctx.lineTo(padding.left, padding.top + chartHeight);
        ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
        ctx.stroke();

        var ticks = 4;
        ctx.fillStyle = 'rgba(100,100,100,0.75)';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        for (var i = 0; i <= ticks; i++) {
            var value = Math.round((maxValue / ticks) * i);
            var y = padding.top + chartHeight - (i / ticks) * chartHeight;
            ctx.strokeStyle = 'rgba(120,120,120,0.12)';
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(padding.left + chartWidth, y);
            ctx.stroke();
            ctx.fillText(String(value), padding.left - 6, y);
        }

        var stepX = chartWidth / Math.max(labels.length - 1, 1);

        series.forEach(function (s) {
            ctx.beginPath();
            s.data.forEach(function (value, index) {
                var x = padding.left + stepX * index;
                var y = padding.top + chartHeight - (value / maxValue) * chartHeight;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.strokeStyle = s.color || '#2563eb';
            ctx.lineWidth = 2;
            ctx.stroke();
        });

        ctx.fillStyle = 'rgba(100,100,100,0.7)';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'alphabetic';
        var labelStep = Math.max(Math.round(labels.length / 6), 1);
        labels.forEach(function (label, index) {
            if (index % labelStep !== 0) {
                return;
            }
            var x = padding.left + stepX * index;
            ctx.fillText(label, x - 10, height - 6);
        });
    }

    document.querySelectorAll('.js-line-chart').forEach(function (canvas) {
        var labels = JSON.parse(canvas.dataset.labels || '[]');
        var series = JSON.parse(canvas.dataset.series || '[]');
        drawLineChart(canvas, labels, series);
        var next = canvas.nextElementSibling;
        if (!next || !next.classList.contains('chart-legend')) {
            var legend = document.createElement('div');
            legend.className = 'chart-legend';
            series.forEach(function (item) {
                var entry = document.createElement('div');
                entry.className = 'chart-legend-item';
                var dot = document.createElement('span');
                dot.className = 'chart-legend-dot';
                dot.style.backgroundColor = item.color || '#2563eb';
                var label = document.createElement('span');
                label.textContent = item.label || '';
                entry.appendChild(dot);
                entry.appendChild(label);
                legend.appendChild(entry);
            });
            canvas.insertAdjacentElement('afterend', legend);
        }
    });
</script>

<style>
    .monitoring-dashboard .kpi-grid{
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px;
    }

    .monitoring-dashboard .kpi-card{
        border: 1px solid var(--theme-border);
        background-color: var(--theme-surface);
        border-radius: 10px;
        padding: 12px 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }

    .monitoring-dashboard .kpi-label{
        font-size: 0.85rem;
        color: var(--theme-text-muted);
        margin-bottom: 4px;
    }

    .monitoring-dashboard .kpi-value{
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--theme-title);
    }

    .monitoring-dashboard .kpi-sub{
        font-size: 0.85rem;
        color: var(--theme-text-muted);
    }

    .monitoring-dashboard .category-grid{
        display: grid;
        gap: 10px;
    }

    .monitoring-dashboard .category-row{
        display: grid;
        grid-template-columns: minmax(160px, 1fr) minmax(120px, 2fr) 50px;
        gap: 12px;
        align-items: center;
    }

    .monitoring-dashboard .category-label{
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
    }

    .monitoring-dashboard .category-icon{
        width: 22px;
        height: 22px;
    }

    .monitoring-dashboard .category-bar{
        background-color: var(--theme-surface-alt);
        border-radius: 99px;
        height: 8px;
        position: relative;
        overflow: hidden;
    }

    .monitoring-dashboard .category-bar span{
        display: block;
        height: 100%;
        width: var(--category-width, 0%);
        background-color: var(--theme-accent);
        border-radius: 99px;
    }

    .monitoring-dashboard .category-count{
        text-align: right;
        font-weight: 600;
    }

    .monitoring-dashboard .status-grid{
        display: grid;
        gap: 10px;
    }

    .monitoring-dashboard .status-item{
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
        padding: 8px 10px;
        border-radius: 8px;
        background-color: var(--theme-surface-alt);
        border: 1px solid var(--theme-border);
    }

    .monitoring-dashboard .status-item strong{
        font-weight: 700;
    }

    .monitoring-dashboard .list-group-item{
        border-color: var(--theme-border);
    }

    .monitoring-dashboard .chart-legend{
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 10px;
        color: var(--theme-text-muted);
        font-size: 0.85rem;
    }

    .monitoring-dashboard .chart-legend-item{
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .monitoring-dashboard .chart-legend-dot{
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
    }
</style>
{% endblock %}
