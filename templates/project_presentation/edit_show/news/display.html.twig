
{% embed "/project_presentation/edit_show/skeletons/structure_content.html.twig" with {'iconName': "news", 'title': "Actualités",} %}

      {% block editButtons %}

        {# Add a news button (triggers a covering footer to create the news) #}

        <button class="js-footer-news pp-edition-mode plus-btn btn btn-light btn-sm me-3" data-pp-id="{{ presentation.id }}"><span class="plus-sign">+</span></button>


    {% endblock %}

    {% block deleteElementsButtons %}

        {% if countNews > 0 %}
        
            {{ parent() }}
        
        {% endif %}

    {% endblock %}

    {% block mainContent %}

        <div id="news" class="" data-structure="news">

            {% if countNews > 0 %}

                <link href="/css/news_card.css" rel="stylesheet">
            
                {% for news in presentation.news | reverse %}

                    {% set newsTextContent = news.textContent %}

                    <div class="news-slide" data-news-id="{{ news.id }}">

                        {% include "project_presentation/edit_show/news/card.html.twig" %}

                        {% include "comment/_news_comments_inline.html.twig" with {
                            commentedEntityType: "news",
                            commentedEntityId: news.id,
                            commentedEntityComments: news.comments
                        } %}

                    </div>

                {% endfor %}  

                {% if countNews > 1 %} {# More than one news, we use a slider #}
                            
                    {# News slider controls #}

                    <div class="newsSliderControls">

                        <a class="item previousNewsSlide" onclick="plusSlidesNews(-1)"><span class="left-chevron">&#10094;</span></a>
                        <a class="item nextNewsSlide" onclick="plusSlidesNews(1)"><span class="right-chevron">&#10095;</span></a>
                    
                    </div>

                    {# News slider script #}
                    <script>
                        
                        let slideIndexNews = 1;
                        const newsSliderDisabled = window.matchMedia('(max-width: 580px)').matches;

                        // Next/previous controls
                        function plusSlidesNews(n) {
                        if (newsSliderDisabled) {
                            return;
                        }
                        showSlidesNews(slideIndexNews += n);
                        }

                        function showSlidesNews(n) {
                        if (newsSliderDisabled) {
                            return;
                        }
                        let i;
                        let slides = document.getElementsByClassName("news-slide");
                        
                        if (n > slides.length) {slideIndexNews = 1}
                        if (n < 1) {slideIndexNews = slides.length}
                        for (i = 0; i < slides.length; i++) {
                            slides[i].style.display = "none";
                        }
                        slides[slideIndexNews-1].style.display = "flex";
                        } 
                        
                        
                    </script>

                {% endif %}
                
                <style>

                    {# Here we overide some news_card.css default styles #}

                    {# initialize news cards slider #}

                    .news-slide{
                        display: none;
                    }

                    .news-slide:first-of-type{
                        display: flex;
                    }

                    {# end of initialize news cards slider #}

                    .news-slide{
                        margin-bottom: 30px;
                    }


                    .newsSliderControls{
                        display: flex;
                        justify-content: space-between;
                        width: 100%;
                        position: absolute;
                        top: 45%;
                    }


                    .newsSliderControls .item:hover{

                        background-color: rgba(211, 253, 214, 0.8);

                    }

                    .newsSliderControls .item{

                        display: inline-block;
                        width: 50px;
                        height: 50px;
                        line-height: 50px;
                        text-align: center;
                        font-size: 20px;
                        border-radius: 50%;
                        color: white;
                        text-decoration: none;
                        cursor: pointer;  
                        font-weight: bold;  
                        transition: 0.6s ease;
                        user-select: none;
                        background-color: #e2f6e1;

                    }

                    .newsSliderControls .item .left-chevron, .newsSliderControls .item .right-chevron{

                        padding-bottom: 5px;
                        color: #83b5ff;
                        display: inline-block;



                    }




                    @media screen and (max-width: 1280px) {

                        .newsSliderControls .item{

                            margin-left: -10px;
                            margin-right: -10px;

                        }


                    }



                    @media screen and (max-width: 580px) {

                        .news-slide{
                            margin-bottom: 10px;
                        }

                        .newsSliderControls{

                            display: none;

                        }

                    }
                
                </style>

                {# Show more news text content #}

                <script>

                    $(document).ready(function(){

                        $('.show-more span').on('click', function(e){
                            e.preventDefault();
                            var $this = $(this); 
                            var $content = $this.closest('.news-card').find('.text-content');
                            $content.removeClass("hideContent").addClass("showContent");
                            $(this).parent().hide();
                            

                        });

                    })
                </script>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        var drawer = document.getElementById('news-comments-drawer');
                        var backdrop = document.querySelector('.news-comments-backdrop');
                        if (!drawer || !backdrop) {
                            return;
                        }

                        var panel = drawer.querySelector('.news-comments-panel');
                        var body = drawer.querySelector('.news-comments-body');
                        var title = drawer.querySelector('.news-comments-title');
                        var closeBtn = drawer.querySelector('.news-comments-close');

                        var isOpen = function () {
                            return drawer.classList.contains('is-open');
                        };

                        var openDrawer = function () {
                            drawer.classList.add('is-open');
                            backdrop.classList.add('is-open');
                            document.body.classList.add('news-comments-open');
                            drawer.setAttribute('aria-hidden', 'false');
                        };

                        var closeDrawer = function () {
                            drawer.classList.remove('is-open');
                            backdrop.classList.remove('is-open');
                            document.body.classList.remove('news-comments-open');
                            drawer.setAttribute('aria-hidden', 'true');
                        };

                        var renderLoading = function () {
                            body.innerHTML = '<div class="news-comments-loading">Chargement…</div>';
                        };

                        var renderError = function () {
                            body.innerHTML = '<div class="text-muted">Impossible de charger les commentaires.</div>';
                        };

                        var loadComments = function (url, count) {
                            if (!url) {
                                renderError();
                                return;
                            }

                            renderLoading();

                            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                                .then(function (response) {
                                    if (!response.ok) {
                                        throw new Error('Bad response');
                                    }
                                    return response.json();
                                })
                                .then(function (data) {
                                    body.innerHTML = data.html || '';
                                    if (typeof data.count !== 'undefined' && title) {
                                        title.textContent = 'Commentaires (' + data.count + ')';
                                    } else if (typeof count !== 'undefined' && title) {
                                        title.textContent = 'Commentaires (' + count + ')';
                                    }
                                })
                                .catch(function () {
                                    renderError();
                                });
                        };

                        document.addEventListener('click', function (event) {
                            var trigger = event.target.closest('.news-comments-trigger');
                            if (!trigger) {
                                return;
                            }
                            event.preventDefault();
                            var url = trigger.getAttribute('data-comments-url');
                            var count = trigger.getAttribute('data-comments-count');
                            var newsId = trigger.getAttribute('data-news-id');
                            if (newsId) {
                                drawer.setAttribute('data-news-id', newsId);
                            }
                            openDrawer();
                            loadComments(url, count);
                        });

                        closeBtn.addEventListener('click', function () {
                            closeDrawer();
                        });

                        backdrop.addEventListener('click', function () {
                            closeDrawer();
                        });

                        document.addEventListener('keydown', function (event) {
                            if (event.key === 'Escape' && isOpen()) {
                                closeDrawer();
                            }
                        });
                    });
                </script>

            {% endif %}


        </div>

        <div id="news-comments-drawer" class="news-comments-drawer" aria-hidden="true">
            <div class="news-comments-panel" role="dialog" aria-modal="true" aria-label="Commentaires">
                <div class="news-comments-header">
                    <span class="news-comments-title">Commentaires</span>
                    <button type="button" class="news-comments-close" aria-label="Fermer les commentaires">&times;</button>
                </div>
                <div class="news-comments-body">
                    <div class="news-comments-loading">Chargement…</div>
                </div>
            </div>
        </div>
        <div class="news-comments-backdrop" data-news-comments-backdrop></div>

        <style>
        
            #news{

                position: relative;
            }

            @media screen and (max-width: 580px) {

                #news{
                    display: flex;
                    gap: 14px;
                    overflow-x: auto;
                    scroll-snap-type: x mandatory;
                    -webkit-overflow-scrolling: touch;
                    padding-bottom: 8px;
                }

                #news::-webkit-scrollbar {
                    display: none;
                }

                .news-slide {
                    display: block;
                    flex: 0 0 90%;
                    max-width: none;
                    scroll-snap-align: start;
                    scroll-snap-stop: always;
                }

                .news-slide .news-card {
                    width: 100%;
                    max-width: none;
                }

            }
        
        
        </style>

    {% endblock %}

{% endembed %}
