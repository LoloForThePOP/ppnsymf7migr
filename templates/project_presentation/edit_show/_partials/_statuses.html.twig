
{# statuses catalog #}

{% set catalog = constant('App\\\Enum\\\ProjectStatuses::CATALOG') %}

{% set thisProjectActiveStatuses = presentation.getStatuses() %}


{# to do : remove project id in data-project-id AND data-update-url, use stringId instead #}

<div id="project-statuses-editor"
     class="project-statuses"
     data-project-id="{{ presentation.id }}"
     data-update-url="{{ path('ajax_project_statuses_update', { id: presentation.id }) }}">

    {% for category in catalog %}

        <div class="status-category mb-4">

            <h5 class="fw-bold text-muted mb-2">
                {{ category.categoryLabels.description_fr }}
            </h5>

            <div class="d-flex flex-wrap gap-2">

                {% for item in category.items %}
                    {% set isActive = item.uniqueName in thisProjectActiveStatuses %}
                    <div class="status-pill px-3 py-2 rounded-pill {{ isActive ? 'active' }}"
                         data-status="{{ item.uniqueName }}"
                         style="background-color: {{ item.bg_color }};"
                         title="{{ item.description_fr }}">
                        {{ item.short_description_fr }}
                    </div>
                {% endfor %}

            </div>

        </div>

    {% endfor %}


    <div class="mt-3">
        <label for="status-remarks" class="form-label fw-bold">Détail sur l’avancement :</label>
        <textarea id="status-remarks"
                  class="form-control"
                  rows="3"
                  placeholder="Ajoutez des précisions sur votre avancement...">{{ presentation.statusRemarks }}</textarea>
        <small class="text-muted d-none" id="remarks-feedback"></small>
    </div>

</div>



<style>

.project-statuses {
    margin-top: 1rem;
}

.status-pill {
    font-size: 0.9rem;
    color: #222;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    cursor: default;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.status-pill:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}


.status-pill.active {
    outline: 2px solid #4b9c3f;
    font-weight: 600;
}



</style>


  {% macro pill(item) %}

        <span class="status-pill-view px-3 py-2 rounded-pill text-dark fw-semibold"
            data-status="{{ item.uniqueName }}"
            style="background-color: {{ item.bg_color }};"
            title="{{ item.description_fr }}">
            {{ item.short_description_fr }}
        </span>

    {% endmacro %}


    {% import _self as pills %}

    <template id="status-pill-template">

        {{ pills.pill({ uniqueName: '', bg_color: '#ddd', description_fr: '', short_description_fr: '' }) }}
        
    </template>

    <div id="project-statuses-view"
        class="project-statuses-view d-flex flex-wrap gap-2"
        data-current-statuses='{{ presentation.statuses | json_encode }}'
        data-catalog="{{ catalog | json_encode }}"
    >

        {% for item in presentation.getEnumStatusItems() %}
            {{ pills.pill(item) }}
        {% endfor %}


                

    </div>

<div id="project-status-remarks-view" class="mt-3 w-100">
            <div class="border-start ps-3 text-muted fst-italic">
                {{ presentation.statusRemarks|nl2br }}
            </div>
        </div>
  


<script>




$(document).on('click', '.status-pill', function() {
    const $pill = $(this);
    const $container = $('#project-statuses-editor');
    const updateUrl = $container.data('update-url');
    const remarks = $('#status-remarks').val();

    const $feedback = $('#remarks-feedback');
    $feedback.text('⟳ Sauvegarde...').removeClass('text-success text-danger d-none').addClass('text-muted');



    // Toggle UI
    $pill.toggleClass('active');

    // Gather all active statuses
    const activeStatuses = $container.find('.status-pill.active').map(function() {
        return $(this).data('status');
    }).get();

    // Send update to backend
    $.ajax({

        url: updateUrl,
        type: 'POST',
        data: JSON.stringify({ statuses: activeStatuses, remarks: remarks }),
        contentType: 'application/json',

        success: function (response) {
            console.log('Statuses saved:', response.enumStatuses);
            $(document).trigger('statuses:updated', [response.enumStatuses, response.statusRemarks]); // Sending an updated event so that we update view
                        $feedback.text('✓ Enregistré').removeClass('text-muted').addClass('text-success');
            setTimeout(() => $feedback.addClass('d-none'), 1500);
        },

        error: function (xhr) {
            console.error('Error saving statuses:', xhr.responseText);
        }

    });

});



</script>





    <script>
$(document).on('statuses:updated', function (event, newStatuses, newRemarks) {
    const $container = $('#project-statuses-view');
    const catalog = $container.data('catalog') || [];

    const activeItems = [];
    catalog.forEach(cat => {
        (cat.items || []).forEach(item => {
            if (newStatuses.includes(item.uniqueName)) {
                activeItems.push({
                    status: item.uniqueName,
                    label: item.short_description_fr,
                    title: item.description_fr,
                    color: item.bg_color,
                });
            }
        });
    });

    console.log(activeItems); // ✅ Now filled correctly
    TemplateManager.renderList('#project-statuses-view', '#status-pill-template', activeItems);

        const $remarkBox = $('#project-status-remarks-view');


    // Update remark text
    if ($remarkBox.length) {
        $remarkBox.text(newRemarks || '');
    }


});



    </script>

{# 
<div class="project-statuses-view">

    <pre>
        {{ dump(presentation.getEnumStatusItems()) }}
    </pre>


    <div id="project-statuses-view"
        class="project-statuses-view d-flex flex-wrap gap-2"
        data-current-statuses='{{ presentation.statuses|json_encode }}'
        data-catalog='{{ catalog|json_encode }}'>


                {% for item in presentation.getEnumStatusItems() %}
                    <span class="status-pill-view px-3 py-2 rounded-pill text-dark fw-semibold"
                        data-status="{{ item.uniqueName }}"
                        style="background-color: {{ item.bg_color }};"
                        title="{{ item.description_fr }}">
                        {{ item.short_description_fr }}
                    </span>
                {% endfor %}
    </div>


</div> #}


<script>
/* 
$(document).on('statuses:updated', function (event, newStatuses) {
    const $container = $('#project-statuses-view');

    // Parse catalog from data attribute
    const catalog = $container.data('catalog');
    if (!catalog) return;

    // Clear old pills
    $container.empty();

    // Build fresh pills from updated statuses
    const statuses = Array.isArray(newStatuses) ? newStatuses : [];
    let count = 0;

    catalog.forEach(category => {
        if (!category.items) return;
        category.items.forEach(item => {
            if (statuses.includes(item.uniqueName)) {
                count++;
                const pill = $('<span>', {
                    class: 'status-pill-view px-3 py-2 rounded-pill text-dark fw-semibold',
                    'data-status': item.uniqueName,
                    css: { backgroundColor: item.bg_color },
                    title: item.description_fr,
                    text: item.short_description_fr
                }).hide().fadeIn(150);
                $container.append(pill);
            }
        });
    });

    if (count === 0) {
        $container.append('<span class="text-muted">Aucun statut défini</span>');
    }
}); */



</script>