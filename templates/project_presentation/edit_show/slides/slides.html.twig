{% block stylesheet %}

<link href="/css/slideshow.css" rel="stylesheet">

{% endblock %}

{% if userPresenter %}

	{% embed "/project_presentation/edit_show/skeletons/structure_content.html.twig" with {'iconName': "slideshow", 'title': "Diaporama", 'additionalClasses': "pp-edition-mode", 'helpContext': "slides",} %}

		{% block editButtons %}
	
			{# Add an image button (triggers a modal with a form) #}
		
			<button type="button" data-bs-toggle="modal" data-bs-target="#addImageSlideFormModal"
			class="pp-edition-mode add-media-btn btn btn-sm me-3">+ Image</button>

			{# Add a video button (triggers a modal with a form) #}

				<button type="button" class="pp-edition-mode add-media-btn btn btn-sm me-3" data-bs-toggle="modal" data-bs-target="#addVideoSlideFormModal">+ Video</button>

			{% if countSlides > 1 %}

				{# Link to reorder slides page #}

					<a id="manage-slides" href="{{ path('pp_reorder_slides', {'stringId': presentation.stringId}) }}" class="pp-edition-mode btn btn-light btn-sm d-lg-none text-decoration-none me-3" aria-label="Gérer l'ordre et les titres des diapositives">Ordre</a>
			
			{% endif %}
		
		{% endblock %}

		{% block deleteElementsButtons %}

        {% if countSlides > 0 %}
        
            {{ parent() }}
        
        {% endif %}

    {% endblock %}

	{% endembed %}

{% endif %}

<!-- Project Presentation Slideshow Display -->
<!-- Structure Container -->

	<!-- Slideshow Container -->

	<div id="slides" class="slideshow-container">

		{% if countSlides > 0 %}
			<button
				id="slideshow-fullscreen-toggle"
				class="slideshow-fullscreen-toggle pp-consultation-mode"
				type="button"
				aria-label="Activer le plein ecran"
				title="Plein ecran"
			>
				<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
					<path fill="currentColor" d="M4 4h6v2H6v4H4V4zm10 0h6v6h-2V6h-4V4zM4 14h2v4h4v2H4v-6zm14 0h2v6h-6v-2h4v-4z"></path>
				</svg>
			</button>
			<button
				id="slideshow-fullscreen-exit"
				class="slideshow-fullscreen-exit pp-consultation-mode"
				type="button"
				aria-label="Quitter le plein ecran"
				title="Quitter le plein ecran"
			>
				<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
					<path fill="currentColor" d="M9 9H4V4h2v3h3v2zm11 0h-5V7h3V4h2v5zm-11 6v5H4v-5h2v3h3v2zm11 5h-5v-2h3v-3h2v5z"></path>
				</svg>
				Quitter le plein ecran
			</button>
		{% endif %}

		{% if countSlides == 0 %}

			<div class="text-placeholder" data-bs-toggle="modal" data-bs-target="#addImageSlideFormModal">Ajoutez des images pour illustrer votre projet !</div>

			<img id="" class="no-slide" data-bs-toggle="modal" data-bs-target="#addImageSlideFormModal" src="{{ asset('no_slide.png', 'pp_wysiwyg')}}"  alt="Two cute teddy bears from behing looking at a windows.">

			<style>

				.slideshow-container{
					display: flex;
					flex-direction: column;
					align-items: center;
					justify-content: center;
				}

				.slideshow-container .text-placeholder {
					margin-bottom: 7px;
					font-weight: bold;
					cursor: pointer;
					color: var(--theme-text);
				}
			
				img.no-slide {
					max-width: 100%;
					max-height: 270px;
					margin: auto;
					border-radius: 12px;
					cursor: pointer;
				}



				@media screen and (max-width: 580px) {

					.slideshow-container .text-placeholder {
						text-align: center;
						font-size: 13px;
					}
			
            	}
			
			</style>

		{% else %}
		
			<!-- Caption Container -->
						
			<div class="caption-container {{userPresenter ? "col-lg-9" : "col-lg-12" }}" >

				{% for slide in presentation.slides %}
						
					{# span is used because <br> is inserted into contenteditable html element if left empty #}

					<span class="caption" data-text="Titre ou légende de l'image" data-edit='{"entity": "slide", "property": "caption", "id": {{slide.id}} }' data-slide-id="{{slide.id}}">{{ slide.caption[:1] | upper ~ slide.caption[1:] }}</span>
					
				{% endfor %}

			</div>
			
			<div class="row m-0">
					
				{#  Slides Container #}

				<div class="slides-container px-0 col edit-hoverable-item"> 

					{% include "project_presentation/edit_show/slides/_slides_container.html.twig" %}

				</div>

				{#  Thumbnails Container #}
				{% set showThumbnails = false %}

				{% if countSlides > 1 and userPresenter %}
					
					{% set showThumbnails = true %}
				
				{% endif %}

				{% if userPresenter %} {# Displaying Thumbnails only for user presenters so they can change orders #}
					
					<div class="pp-edition-mode thumbnails-container col-lg-2 px-0 d-none {{ showThumbnails ? 'd-lg-flex' }} flex-column align-items-center">
					
						{% include "project_presentation/edit_show/slides/_thumbnails_container.html.twig" %}
						
					</div>

				{% endif %}

			</div>			



		{% endif %}


	</div>

	{# Check if we have captions #}

	<script>
		
		// Toggle caption area depending on the currently visible slide.
		function updateCaptionContainerVisibility(currentIndex){
			var captions = document.getElementsByClassName("caption");
			var currentCaption = captions[currentIndex] || null;
			var captionText = '';

			if (currentCaption) {
				captionText = $.trim($(currentCaption).text());
			}

			// In consultation mode, only a real caption text should keep this area visible.
			if (captionText !== '') {
				$('.caption-container').removeClass('no-caption');
			} else {
				$('.caption-container').addClass('no-caption');
			}
		}

		
		// remove thumbnails container when only one slide is displayed


		if ($('.mySlides').length == 1) {

			$('#slides').addClass('only-one-slide');

		} 


	</script>

	{# displaying appropriate image or video slide when hovering its thumbnail (a mess if more than 4 slides ) #}

	<script>

		mouseoverThumbnail(); //if($( ".thumbnail" ).length < 5) {}

		function mouseoverThumbnail() {
		
			$( ".thumbnail" ).mouseover(function() {

				currentSlide($(this).data("loop-index"));
				
			});

		}

		updateCaptionContainerVisibility(0);

		

	</script>


	
    <script>

		var isSlideshowFullscreen = false;
        var slideIndex = 1;

		function isConsultationModeActive() {
			var ppContainer = document.querySelector('.pp-container');
			return !!(ppContainer && ppContainer.classList.contains('in-consultation-mode'));
		}

		function isTinyScreenForFullscreen() {
			return window.matchMedia('(max-width: 768px)').matches;
		}

		function getFullscreenElement() {
			return document.fullscreenElement || document.webkitFullscreenElement || null;
		}

		function requestFullscreenElement(element) {
			if (!element) {
				return Promise.resolve();
			}
			if (typeof element.requestFullscreen === 'function') {
				return element.requestFullscreen();
			}
			if (typeof element.webkitRequestFullscreen === 'function') {
				element.webkitRequestFullscreen();
			}
			return Promise.resolve();
		}

		function exitFullscreenElement() {
			if (typeof document.exitFullscreen === 'function') {
				return document.exitFullscreen();
			}
			if (typeof document.webkitExitFullscreen === 'function') {
				document.webkitExitFullscreen();
			}
			return Promise.resolve();
		}

		function updateSlideshowFullscreenState() {
			var slideshowRoot = document.getElementById('slides');
			var fullscreenButton = document.getElementById('slideshow-fullscreen-toggle');
			var activeElement = getFullscreenElement();

			isSlideshowFullscreen = !!(slideshowRoot && activeElement === slideshowRoot);
			if (slideshowRoot) {
				slideshowRoot.classList.toggle('is-slideshow-fullscreen', isSlideshowFullscreen);
			}
			if (fullscreenButton) {
				fullscreenButton.setAttribute('aria-label', isSlideshowFullscreen ? 'Quitter le plein ecran' : 'Activer le plein ecran');
				fullscreenButton.setAttribute('title', isSlideshowFullscreen ? 'Quitter le plein ecran' : 'Plein ecran');
			}
		}

		function toggleSlideshowFullscreen() {
			var slideshowRoot = document.getElementById('slides');
			if (!slideshowRoot) {
				return;
			}

			// On tiny screens, keep slideshow in-page and avoid entering fullscreen.
			if (isTinyScreenForFullscreen() && !isSlideshowFullscreen) {
				return;
			}

			if (isSlideshowFullscreen) {
				exitFullscreenElement();
			} else {
				requestFullscreenElement(slideshowRoot);
			}
		}

		function bindImageClickToFullscreen(slideshowRoot) {
			if (!slideshowRoot) {
				return;
			}

			slideshowRoot.addEventListener('click', function (event) {
				if (event.defaultPrevented || !isConsultationModeActive()) {
					return;
				}

				var clickedOnControl = event.target.closest('.slideshow-fullscreen-toggle, .slideshow-fullscreen-exit, .prev, .next');
				if (clickedOnControl) {
					return;
				}

				var clickedOnImageMedia = event.target.closest('.image-slide-wrapper > img, .img-zoom-lens, .img-zoom-result');
				var clickedOnVideoMedia = event.target.closest('.video-slide-wrapper iframe');

				if (isSlideshowFullscreen) {
					// In fullscreen, clicking outside media exits fullscreen.
					if (!clickedOnImageMedia && !clickedOnVideoMedia) {
						toggleSlideshowFullscreen();
					}
					return;
				}

				// On tiny screens, do not trigger fullscreen from image clicks.
				if (isTinyScreenForFullscreen()) {
					return;
				}

				// In normal mode, keep "click image to enter fullscreen".
				if (clickedOnImageMedia) {
					toggleSlideshowFullscreen();
				}
			});
		}

		document.addEventListener('fullscreenchange', function () {
			updateSlideshowFullscreenState();
			showSlides(slideIndex);
		});

		document.addEventListener('webkitfullscreenchange', function () {
			updateSlideshowFullscreenState();
			showSlides(slideIndex);
		});

		(function bindSlideshowFullscreen() {
			var fullscreenButton = document.getElementById('slideshow-fullscreen-toggle');
			var fullscreenExitButton = document.getElementById('slideshow-fullscreen-exit');
			var slideshowRoot = document.getElementById('slides');
			if (!fullscreenButton) {
				return;
			}
			var fullscreenSupported = !!(slideshowRoot && (slideshowRoot.requestFullscreen || slideshowRoot.webkitRequestFullscreen));
			if (!fullscreenSupported) {
				fullscreenButton.style.display = 'none';
				if (fullscreenExitButton) {
					fullscreenExitButton.style.display = 'none';
				}
				return;
			}

			fullscreenButton.addEventListener('click', function () {
				toggleSlideshowFullscreen();
			});
			if (fullscreenExitButton) {
				fullscreenExitButton.addEventListener('click', function () {
					if (isSlideshowFullscreen) {
						toggleSlideshowFullscreen();
					}
				});
			}
			bindImageClickToFullscreen(slideshowRoot);
			updateSlideshowFullscreenState();
		})();

		document.addEventListener('keydown', function (event) {
			if (event.defaultPrevented) {
				return;
			}
			if (event.key !== 'f' && event.key !== 'F') {
				return;
			}

			var target = event.target;
			if (target && (target.isContentEditable || /^(INPUT|TEXTAREA|SELECT|BUTTON)$/.test(target.tagName))) {
				return;
			}

			var slideshowRoot = document.getElementById('slides');
			if (!slideshowRoot) {
				return;
			}

			event.preventDefault();
			toggleSlideshowFullscreen();
		});

        function plusSlides(n) {

            showSlides(slideIndex += n);
            
        }

        function currentSlide(n) {
            showSlides(slideIndex = n);
        }

        function showSlides(n) {

            var i;
            var slides = document.getElementsByClassName("mySlides");
            var dots = document.getElementsByClassName("SlideImageThumbnail");
            var thumbnail = document.getElementsByClassName("thumbnail");
            var captions = document.getElementsByClassName("caption");
            var captionText = document.getElementById("captionText");
            
            if (n > slides.length) {slideIndex = 1}
            
            if (n < 1) {slideIndex = slides.length}
            
            for (i = 0; i < slides.length; i++) {

                slides[i].style.display = "none";

                if(typeof(captions[i]) != 'undefined'){
                    captions[i].style.display = "none";
                }
                
            }
            
            for (i = 0; i < dots.length; i++) {
                dots[i].className = dots[i].className.replace(" active", "");
                thumbnail[i].className = thumbnail[i].className.replace(" active", "");
            }
            
            slides[slideIndex-1].style.display = "flex";

            if(!tinyScreen && !isSlideshowFullscreen && typeof killImageZoom === 'function' && typeof imageZoom === 'function'){

                killImageZoom(); //deleting previous lens
                imageZoom("image-slide-wrapper-"+slides[slideIndex-1].id, "image-zoom-result");
            } else if (typeof killImageZoom === 'function') {
                killImageZoom();
            }

            if(typeof(captions[slideIndex-1]) != 'undefined'){
                captions[slideIndex-1].style.display = "block";
            }

			updateCaptionContainerVisibility(slideIndex - 1);
            
            dots[slideIndex-1].className += " active";
            thumbnail[slideIndex-1].className += " active";

            if(typeof(captionText) != 'undefined' && captionText !== null){
                var text = '';
                if (captions[slideIndex-1] && captions[slideIndex-1].textContent) {
                    text = captions[slideIndex-1].textContent;
                } else if (dots[slideIndex-1]) {
                    text = dots[slideIndex-1].getAttribute('data-caption') || '';
                }
                captionText.textContent = text;
            }

        }

		$(document).ready(function(){ //otherwise first slide caption doesn't show in webpage load

			showSlides(slideIndex);

		});

    </script>
