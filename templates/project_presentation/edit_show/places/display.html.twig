
{% embed "/project_presentation/edit_show/skeletons/structure_content.html.twig" with {'iconName': "geodomains", 'title': "Lieux du Projet",} %}


    {% block editButtons %}

        {# Manage places button #}

        <button
            type="button"
            class="pp-edition-mode edit-places-btn"
            data-bs-toggle="modal"
            data-bs-target="#managePlacesModal"
        >
            <img class="edit-icon" src="{{ asset('edit.svg', 'pp_wysiwyg')}}" height="17" width="17" alt="edit icon" >
        </button>

        {% if countPlaces == 0 %}

            <button
                type="button"
                class="pp-edition-mode pp-info-tooltip"
                title="Si votre projet est relié à des villes ou d'autres lieux (régions; pays; etc.), signalez-les ici."
                aria-label="Si votre projet est relié à des villes ou d'autres lieux (régions; pays; etc.), signalez-les ici."
            >i</button>

        {% endif %}

    {% endblock %}

    {% block deleteElementsButtons %}

        {% if countPlaces > 0 %}
        
            {{ parent() }}
        
        {% endif %}

    {% endblock %}

    {% block mainContent %}
                
        <div
            id="places"
            class="js-elements-list pp-struct-content"
            data-structure="places"
        >

            {% if countPlaces > 0 %}

                {% for place in presentation.places %}

                    {# create a human readable place type #}
                    {# ex: (City of) London (United Kingdom) #}

                    {% set readablePlace = "" %}
                    {% set readablePlaceDetails = "" %}

                    {% if place.type =="locality" %}

                        {% set readablePlace = place.name ~ " (" ~ place.administrativeAreaLevel1 ~ ")" ~ " (" ~ place.country ~ ")" %}

                    {% elseif place.type =="postal_code" %}

                        {# in this case, place.name is postal code #}

                        {% set readablePlace = place.locality ~ " (" ~ place.administrativeAreaLevel1 ~ ")" ~ " (" ~ place.country ~ ")" %}

                    {% elseif place.type =="street_number" %}

                        {% set readablePlace = place.locality ~ " (" ~ place.administrativeAreaLevel1 ~ ")" ~ " (" ~ place.country ~ ")" %}

                        {% set readablePlaceDetails = place.name %}

                    {% elseif place.type == "route" %}

                        {% set readablePlace = place.locality ~ " (" ~ place.administrativeAreaLevel1 ~ ")" ~ " (" ~ place.country ~ ")" %}
                        
                        {% set readablePlaceDetails = "" %}

                    {% elseif place.type == "sublocality_level_1" %}

                        {% set readablePlace = place.name ~ " (" ~ place.administrativeAreaLevel1 ~ ")" ~ " (" ~ place.country ~ ")" %}

                    {% elseif place.type =="administrative_area_level_1" %}

                        {% set readablePlace = "Région " ~ place.name %}

                    {% elseif place.type =="administrative_area_level_2" %}

                        {% set readablePlace = "Département : " ~ place.name %}

                    {% elseif place.type =="country" %}

                        {% set readablePlace = place.name %}
                    
                    {% endif %}

                    {# Place card display #}


                    {# Place can be displayed in a modal on card click #}

                    {% set modal_id = 'place-'~ place.id %}
                            
                    {% embed "utilities/modal_skeleton.html.twig" with {'modal_id': modal_id, 'modal_size': "modal-lg"} %}

                        {% block modalBody %}

                            <div id="js-googleMap-{{place.id}}" style="width:100%; height:400px;"></div>

                        {% endblock %}

                        {% block footerButtons %}
                            
                            {% if userPresenter %}

                                <button
                                    type="button"
                                    class="btn btn-light pp-edition-mode"
                                    data-bs-target="#managePlacesModal"
                                    data-bs-toggle="modal"
                                    data-bs-dismiss="modal"
                                >
                                    Modifier
                                </button>

                            {% endif %}
                        
                        {% endblock %}

                    {% endembed %}

                    <div id="{{place.id}}" class="js-sortable-element place-card">

                        <div data-bs-toggle="modal" data-bs-target="#{{modal_id}}" data-bs-dismiss="modal">

                            {{readablePlace}}

                            {% if readablePlaceDetails is not empty %}{# For example we got an address with a street number #}

                                <div class="place-details">
                                    {{readablePlaceDetails}}
                                </div>
                            
                            {% endif %}

                        </div>
                        
                        {# delete place (Red Cross) button #}

                        <button
                            type="button"
                            data-structure="places"
                            class="js-delete-element delete-button pp-edition-mode btn"
                            data-id="{{place.id}}"
                        >&times;</button>

                    </div>
                    
                {% endfor %}

                {# Google Map Hydrate #}
                            
                <script>

                    function myMap() {

                        {% for place in presentation.places %}

                            var mapProp= {
                            center:new google.maps.LatLng({{place.geoloc.latitude}},{{place.geoloc.longitude}}),
                            zoom:14,
                            };

                            var map = new google.maps.Map(document.getElementById("js-googleMap-{{place.id}}"), mapProp);

                        {% endfor %}
                    }

                    // Wait for Google Maps to be available once the global script (loaded in base.html.twig) is ready.
                    document.addEventListener('DOMContentLoaded', function () {
                        var attempts = 0;
                        var maxAttempts = 40; // ~6s with 150ms interval

                        function initWhenReady() {
                            if (window.google && google.maps) {
                                myMap();
                                return;
                            }
                            if (++attempts < maxAttempts) {
                                setTimeout(initWhenReady, 150);
                            }
                        }

                        initWhenReady();
                    });
                    
                </script>

                <style>

                    #places{

                        padding-left: 15px;
                        padding-right: 15px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;

                    }

                    .place-card{

                        position: relative;
                        padding: 10px 15px 10px 17px;
                        margin-bottom: 10px;
                        font-size: 17px;
                        font-weight: bold;
                        cursor: pointer;
                        border-left: 3px solid var(--theme-accent);
                        background-color: var(--theme-surface-alt);
                        color: var(--theme-text);

                    }

                    .place-card:hover{
                        background-color: var(--theme-surface);
                    }

                    .place-details{

                        font-size: 15px;
                        color: var(--theme-text-muted);

                    }


                    @media screen and (max-width: 580px) {

                        #places{

                            padding-left: 0px;
                            padding-right: 0px;

                        }

                        .place-card{

                            padding: 4px 15px 5px 17px;
                            font-size: 16px;
                            font-weight: normal;
                            cursor: pointer;
                            border-left: 3px solid var(--theme-accent);
                            background-color: var(--theme-surface-alt);
                
                        }

                        .place-details{

                            font-size: 13px;
                        
                        }


                    }

                </style>                
            
            
            {% endif %}

        </div>



    {% endblock %}

{% endembed %}
