
{# Tiny "comment icon + count" display anchored to comment section (shortcut to access comments section while seeing comments count) #}

{% macro commentsIcon(countComments) %}
    
    <a class="d-inline-flex align-items-center" href="#comments-struct-container">

        <div class="d-flex align-items-center lh-1">
            
            <img class="commentIcon icon-themed icon-strong me-2" src="{{ asset('dialog.svg', 'misc')}}" alt="an icon representing a dialog">

            <span class="comment-count">{{countComments}}</span> 
        
        </div>
    
    </a>
    
{% endmacro %}




{# Dropdown containing more info about the project #}

{% macro threeDotsMoreInfo(pageInfo) %}
    
    <img id="" class="upper-box-page-info-icon icon-themed icon-strong cursor-pointer" src="{{ asset('three_dots.svg', 'misc')}}" alt="three dots icon" width="25" height="25" data-bs-toggle="dropdown" aria-expanded="false" type="button">

    {# Dropdown Content #}

    <ul id="page-info-dropdown-content" class="dropdown-menu px-3" aria-labelledby="page-info-dropdown" style="max-width: 360px;">

        {{pageInfo}}

    </ul>
    
{% endmacro %}

{#
    Crowdfunding summary row (3P upper box)
    - Uses PPBase.funding_* fields (end_at/status/platform) and optional ingestion source_url.
    - platform_icon() resolves a favicon slug (ex: "ulule") via PlatformIconResolver.
    - Full flow + extension guide: docs/crowdfunding-section.md
#}
{% macro fundingInfo(presentation, extraClasses) %}
    {% set fundingEndAt = presentation.fundingEndAt %}
    {% set fundingStatus = presentation.fundingStatus %}
    {% set fundingPlatform = presentation.fundingPlatform %}
    {% set sourceUrl = presentation.ingestion ? presentation.ingestion.sourceUrl : null %}
    {% set safeSourceUrl = sourceUrl|safe_href %}
    {% set platformIcon = platform_icon(fundingPlatform, sourceUrl) %}
    {% if fundingEndAt or fundingStatus or fundingPlatform %}
        {% set isPast = fundingEndAt and fundingEndAt < date() %}
        {% set statusLabels = {
            ongoing: 'en cours',
            success: 'r√©ussie',
            failed: '√©chou√©e',
            cancelled: 'annul√©e',
            ended: 'termin√©e'
        } %}
        {% set statusText = fundingStatus ? (statusLabels[fundingStatus]|default(fundingStatus)) : null %}
        {% if statusText is empty %}
            {% set statusText = isPast ? 'termin√©e' : 'en cours' %}
        {% endif %}
        {% set dateText = null %}
        {% if fundingEndAt %}
            {% if isPast or statusText in ['r√©ussie', '√©chou√©e', 'annul√©e', 'termin√©e'] %}
                {% set dateText = 'termin√©e le ' ~ fundingEndAt|date('d/m/Y') %}
            {% else %}
                {% set dateText = 'termine le ' ~ fundingEndAt|date('d/m/Y') %}
            {% endif %}
        {% endif %}
        {% set platformLabel = '' %}
        {% if fundingPlatform %}
            {% if safeSourceUrl %}
                {% set platformLabel = '<a class="pp-funding-link" href="' ~ safeSourceUrl ~ '" target="_blank" rel="noopener">(' ~ fundingPlatform ~ ')</a>' %}
            {% else %}
                {% set platformLabel = '(' ~ fundingPlatform ~ ')' %}
            {% endif %}
        {% endif %}
        <div class="pp-funding-info {{ extraClasses|default('') }}">
            {% if platformIcon %}
                {% if safeSourceUrl %}
                    <a class="pp-funding-link" href="{{ safeSourceUrl }}" target="_blank" rel="noopener" aria-label="{{ fundingPlatform ?: platformIcon }}">
                        <span class="pp-funding-icon" style="--pp-platform-icon: url('{{ asset(platformIcon ~ '.png', 'popular_website_logo') }}');" role="img" aria-label="{{ fundingPlatform ?: platformIcon }} logo"></span>
                    </a>
                {% else %}
                    <span class="pp-funding-icon" style="--pp-platform-icon: url('{{ asset(platformIcon ~ '.png', 'popular_website_logo') }}');" role="img" aria-label="{{ fundingPlatform ?: platformIcon }} logo"></span>
                {% endif %}
            {% endif %}
            <span class="pp-funding-label">
                Projet avec financement participatif{% if platformLabel %} {{ platformLabel|raw }}{% endif %} - collecte {{ statusText }}{% if dateText %} ({{ dateText }}){% endif %}
            </span>
        </div>
    {% endif %}
{% endmacro %}


{% set shareIcon %}
    
    <a href="#" class="d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#pp-share" >

        <img class="shareIcon icon-themed icon-strong" src="{{ asset('share.svg', 'misc')}}" alt="share icon" width="22" height="22">
    
    </a>
    
{% endset %}

        
{# Edit project presentation thumbnail link #}

{% macro editPresentationThumbnail (stringId) %}
    
    <span class="pp-edition-mode ms-2 ms-md-3"><a class="pp-edit-thumbnail-link" href="{{ path ('pp_edit_thumbnail', {'stringId': stringId}) }}">üñºÔ∏è Vignette</a></span>
    
{% endmacro %}


{% set hasStatusRemarks = presentation.statusRemarks|default('')|trim is not empty %}
{% set hasEnumeratedStatuses = presentation.getEnumStatusItems()|length > 0 %}
{% set hasStatusContent = hasEnumeratedStatuses or hasStatusRemarks %}

<div class="pp-upper-box pp-struct-container row is-expanded" data-pp-default-expanded="true" data-pp-collapse="disabled" data-tour="pp-hero"> 

    <div class="left-col-md container col-lg-9 d-md-flex align-items-center">

        {# Status & Title Displayed at the top (only for small screens) #}

        <div class="d-flex d-md-none">
            {% if userPresenter and not hasStatusContent %}
                {% include 'project_presentation/edit_show/statuses/edit_button.html.twig' %}
            {% else %}
                {% include 'project_presentation/edit_show/statuses/display.html.twig' %}
            {% endif %}

            {% include 'project_presentation/edit_show/title.html.twig' %}

        </div>

        {# Logo Column & {Title + Goal + keywords} Column #}

        <div class="row w-100">

            {# a logo is displayed in two case : it already exists; or we display a fake logo placeholder for user presenters only #}

            {% if presentation.logo or userPresenter %}
                
                {# Logo Column #} {# when fake logo placeholder, it is only displayed for userPresenter (so we add pp-edition-mode class) #}

                <div id="logo-struct-container" class="pp-logo-container edit-hoverable-item {% if not presentation.logo and userPresenter %} pp-edition-mode {% endif %}">

                    {% include 'project_presentation/edit_show/logo/display.html.twig' %}

                </div>

            {% endif %}

            {# Goal Column (+ Title & Keywords only for >= Medium screens) #}

            <div class="col d-flex align-items-center">

                <div class="container px-0 ps-md-2">

                    {# Title & Status Display only >= Medium Screens #}

                    <div class="d-none d-md-flex align-items-center mb-2">

                        {# Project Title Display #}

                        {% include 'project_presentation/edit_show/title.html.twig' %}

                        {# Project Status Display #}

                        <div class="d-inline ps-2">
                            {% if userPresenter and not hasStatusContent %}
                                {% include 'project_presentation/edit_show/statuses/edit_button.html.twig' %}
                            {% else %}
                                {% include 'project_presentation/edit_show/statuses/display.html.twig' %}
                            {% endif %}
                        </div>
        
                        
        
                    </div>

                    {# Goal Display #}
        
                    <div class="">

                        {% include 'project_presentation/edit_show/goal.html.twig' %}
                        
                    </div>
                    
                    {# Keywords Display only >= Medium Screens #}

                    <div class="d-none d-md-flex align-items-center">
        
                        {% include 'project_presentation/edit_show/categories_keywords/display.html.twig' %}

                        <div class="" style="min-width:110px;">{{ _self.editPresentationThumbnail(presentation.stringId) }}</div>

                    </div>

                    {{ _self.fundingInfo(presentation, 'd-none d-md-flex align-items-center mt-1') }}


</div>

</div>

{# Categories & Keywords modal (needed for the trigger button) #}
{% if userPresenter and categoriesKeywordsForm is defined %}
    {% include 'project_presentation/edit_show/categories_keywords/edition_modal.html.twig' with {
        presentation: presentation,
        categoriesKeywordsForm: categoriesKeywordsForm
    } %}
{% endif %}

        </div>

        {# Categories & Keywords Display & Thumbnail Access Display - only Small Screens #}

        <div class="upper-edition-box-container d-md-none">

            {% include 'project_presentation/edit_show/categories_keywords/display.html.twig' %}

            {{ _self.fundingInfo(presentation, 'd-flex justify-content-center mt-2') }}
            
            {# Project status or progression Edition Icon - only Small Screens #}
            <div class="mt-3">

                {{ _self.EditPresentationThumbnail(presentation.stringId) }}

            </div>

        </div>


        {# Project comments, likes, share - only Small Screens #}

        <div class="pp-consultation-mode d-flex justify-content-center align-items-center mt-0 mt-lg-2 d-lg-none">
        
            <div class="d-flex justify-content-center align-items-center">
            
                <div class="d-flex align-items-center me-3">{{ _self.commentsIcon(countComments) }}</div>

                <div class="d-flex align-items-center me-3">{% include 'project_presentation/edit_show/like_button.html.twig' %}</div>
            
                {{ shareIcon }}
            
            </div>

            <div class="pp-consultation-mode d-flex align-items-center ms-4">
            
                {% include 'project_presentation/edit_show/follow_button.html.twig' %}

            </div>

        </div>

    </div>


    {# Middle column (only >= lg screens) 

    {% if userPresenter %}

        <div class="middle-col-md pp-edition-mode container col-lg-3 d-none d-lg-flex">
        
          {{ newsFormProxy }}
        
        </div>

    {% endif %}#}


    {# Right column (only >= lg screens) #}

    <div class="right-col-md container col-lg-3 d-none d-lg-flex flex-column pp-consultation-mode">
        
        {# Project Likes & Share button #}

        <div class="pp-upper-actions-row d-flex align-items-center px-2 pt-2 pb-0 pt-lg-0 pb-lg-3 mb-lg-3">
        
            <span class="me-3">{% include 'project_presentation/edit_show/like_button.html.twig' %}</span>

            <div class="">{{ shareIcon }}</div>

            <span class="pp-consultation-mode ms-3">{% include 'project_presentation/edit_show/follow_button.html.twig' %}</span>
            
        </div>

        {# Project Comments Count and Access #}

        <div class="edit-third-row px-2 pt-2 pb-0 pt-lg-0 pb-lg-3">
        
            {{ _self.commentsIcon(countComments) }}

        </div>

        <style>


            .in-edition-mode .right-col-md .edit-third-row{

                margin-bottom: 0;

            }

            .pp-upper-actions-row{
                border-bottom: 1px solid var(--theme-border);
            }

            .in-consultation-mode .right-col-md .edit-third-row{

                margin-bottom: 1rem;
                border: none; 
                border-bottom: 1px solid var(--theme-border);

            }
        
        </style>

        {# Presentation More Info (creation date, etc.) #}

        <div class="pp-consultation-mode px-2 pt-2 pb-0 pt-lg-0">

            {{ _self.threeDotsMoreInfo(pageInfo) }}
            

        </div>

 
    </div>


</div>


<style>

    {# In Edition Mode we keep left col full width because the right column is hidden #}

    .in-edition-mode .left-col-md {

        width: 100%;
    }

    .middle-col-md{
        justify-content: center;
        align-items: center;
        border-left: 1px solid var(--theme-border);
    }

    .right-col-md{
        display: flex;
        justify-content: space-evenly;
        padding-left: 10px;
        border-left: 1px solid var(--theme-border);
    }

    .pp-placeholder-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }

    .pp-upper-box {
        margin-bottom: 40px;
    }

    .pp-logo-container{

        scroll-margin-top: 85px;

        position: relative;

        display: flex;
        align-items: center;
        justify-content: center;

        flex: 0 0 auto;
        
        width: 16%;

        padding-right: 0;

    }



    .commentIcon{

        width: 22px;

    }

    .comment-count{
        color: var(--theme-text);
    }

    .pp-upper-box .followed-display .text{
        margin-right: 4px;
        margin-bottom: 1px;
        margin-left: 1px;
    }

    .pp-funding-info{
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 0.95rem;
        color: var(--theme-text-muted);
    }

    .pp-funding-icon{
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 4px;
        background-color: var(--theme-surface);
        background-image: var(--pp-platform-icon);
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        flex: 0 0 auto;
    }

    .pp-funding-link{
        display: inline-flex;
        align-items: center;
        color: var(--theme-accent);
        color: color-mix(in srgb, var(--theme-accent) 70%, var(--theme-text-muted));
        text-decoration: none;
    }

    .pp-funding-link:hover{
        text-decoration: underline;
    }

        
    @media screen and (min-width: 520px) {
            
        .pp-upper-box {

            margin-left: auto;
            margin-right: auto;

            padding: 20px 12px 20px 12px; /* Overriding some pp-struct-container defaults */

        }

    }
        
    @media screen and (max-width: 990px) {
            
        .pp-logo-container{

            width: 21%;

        }
    }
        
    @media screen and (max-width: 580px) {

        .pp-upper-box { /* Overriding some pp-struct-container defaults */
            margin-bottom: 10px;
            padding: 0;
            padding-top: 9px;
            padding-bottom: 20px;
            border-top: 0;
            border-left: 0;
            border-right: 0;
            border-radius: 0;
        }
   
        .upper-edition-box-container{

            text-align: center;
            margin-top: 11px;
            margin-bottom: 15px;
            
        }

        .in-edition-mode .left-col-md {

            width: 100%;
        }

        .pp-logo-container{

            display: flex;
            align-items: center;

            width: 25%;

        }

        .commentIcon{
            width: 20px;
        }

        .likeIcon{
            width: 18px;
        }

        .shareIcon {
            width: 17px;
            height: 17px;
        }

    }

</style>
