<script>

/*
  Ajax call function when user clicks on a status pill
*/
$(document).on('click', '.status-pill', function() {

    // ensure only one per category
    const category = $(this).data('category');
    if (category) {
        $(this).closest('ul').find('.status-pill[data-category="'+category+'"]').not(this).removeClass('active');
    }

    $(this).toggleClass('active');
    
    saveEnumStatusesAndRemarks();

});


/*
  Ajax call function when user type a free status remark (project progress details)
*/
let statusRemarksTimer = null;

$(document).on('input', '#status-remarks-textarea', function () {

    const $textarea = $(this);

    const newRemark = $textarea.val();

    // Clear previous timer
    clearTimeout(statusRemarksTimer);

    // Debounce: wait 800ms after the last keystroke before saving
    statusRemarksTimer = setTimeout(() => {
        saveEnumStatusesAndRemarks(newRemark);
    }, 800);
    
});


/*
  Actual ajax call (live save) when project statuses are updated
*/
function saveEnumStatusesAndRemarks() {

    const $pill = $(this);
    const $container = $('#project-statuses-editor');
    const updateUrl = $container.data('update-url');
    const remarks = $('#status-remarks-textarea').val();

    const $feedback = $('#remarks-feedback');
    $feedback.text('⟳ Sauvegarde...').removeClass('text-success text-danger d-none').addClass('text-muted');

    // Gather all active statuses
    const activeStatuses = $container.find('.status-pill.active').map(function() {
        return $(this).data('status');
    }).get();

    console.log(activeStatuses);

    // Send update to backend
    $.ajax({

        url: updateUrl,
        type: 'POST',
        data: JSON.stringify({ statuses: activeStatuses, remarks: remarks }),
        contentType: 'application/json',

        success: function (response) {

            console.log('Statuses saved:', response.enumStatuses);

            $(document).trigger('statuses:updated', [response.enumStatuses, response.statusRemarks]); // Sending an updated event to update view

            $feedback.text('✓ Enregistré').removeClass('text-muted').addClass('text-success');

            setTimeout(() => $feedback.addClass('d-none'), 1500);
        },

        error: function (xhr) {
            console.error('Error saving statuses:', xhr.responseText);
        }

    });

}



/*
  Statuses:updated Event listener to refresh UI
*/
$(document).on('statuses:updated', function (event, newStatuses, newRemarks) {
    renderStatuses(newStatuses, newRemarks);
});

// Re-render pills and remarks without external dependencies
function renderStatuses(newStatuses, newRemarks) {
    const $containers = $('.project-enumerated-statuses-view');
    if (!$containers.length) {
        return;
    }

    const catalog = $containers.first().data('catalog') || [];

    const activeItems = [];
    catalog.forEach(cat => {
        (cat.items || []).forEach(item => {
            if (newStatuses.includes(item.uniqueName)) {
                activeItems.push({
                    text: item.short_description_fr,
                    status: item.uniqueName,
                    title: item.description_fr,
                    color: item.bg_color,
                });
            }
        });
    });

    console.log(activeItems);
    
    // Re-render the pills inline across all containers (mobile + desktop)
    $containers.each(function () {
        const $container = $(this);
        $container.empty();
        if (!activeItems.length) {
            $container.append('<span class="text-muted">Aucun statut</span>');
        } else {
            activeItems.forEach(item => {
                const pill = $('<span>', {
                    class: 'status-pill-view',
                    'data-status': item.status,
                    title: item.title,
                    text: item.text,
                    css: { backgroundColor: item.color },
                });
                $container.append(pill);
            });
        }
    });

    const $remarkBox = $('.project-status-remarks-view .content');

    // Update remark text
    if ($remarkBox.length) {
        $remarkBox.text(newRemarks || '');
    }

    // Update summary + toggle button
    const showMore = activeItems.length > 1 || ((newRemarks || '').trim().length > 10);
    const $summaryMain = $('.status-summary-main');
    if ($summaryMain.length) {
        if (activeItems.length > 0) {
            const first = activeItems[0];
            $summaryMain.html(
                `<span class="status-pill-view" data-status="${first.status}" title="${first.title}" style="background-color:${first.color};">${first.text}</span>`
            );
        } else if ((newRemarks || '').trim().length > 0) {
            const snippet = (newRemarks || '').slice(0, 30) + ((newRemarks || '').length > 30 ? '…' : '');
            $summaryMain.html(`<span class="text-muted small">${snippet}</span>`);
        } else {
            $summaryMain.html('<span class="text-muted small">Aucun statut</span>');
        }
    }
    $('.status-popover-btn').toggle(showMore);

    // Refresh popover content if present
    initStatusPopovers();
}

// Init or refresh popovers on all buttons
function initStatusPopovers() {
    $('.status-popover-btn').each(function () {
        const btn = this;
        if (!(window.bootstrap && bootstrap.Popover)) return;

        const view = document.querySelector('.status-full-view');
        let contentHtml = '';
        if (view) {
            const clone = view.cloneNode(true);
            clone.classList.remove('d-none');
            $(clone).find('.status-popover-btn').remove();
            contentHtml = clone.outerHTML;
        }
        const existing = bootstrap.Popover.getInstance(btn);
        if (existing) {
            existing.dispose();
        }
        const pop = new bootstrap.Popover(btn, {
            html: true,
            content: contentHtml,
            customClass: 'wide-popover',
            trigger: 'manual',
            sanitize: false,
        });

        $(btn).off('click.statusPopover').on('click.statusPopover', function (e) {
            e.preventDefault();
            // hide other popovers
            $('.status-popover-btn').not(btn).each(function () {
                const inst = bootstrap.Popover.getInstance(this);
                if (inst) inst.hide();
            });

            const instance = bootstrap.Popover.getInstance(btn);
            if (!instance) return;
            const tip = instance.getTipElement ? instance.getTipElement() : null;
            const isShown = tip && tip.classList.contains('show');
            if (isShown) {
                instance.hide();
            } else {
                instance.show();
            }
        });
    });
}

// Close popover when clicking outside
$(document).on('click', function (e) {
    const $trigger = $(e.target).closest('.status-popover-btn, .popover');
    if (!$trigger.length) {
        $('.status-popover-btn').each(function () {
            const inst = bootstrap.Popover.getInstance(this);
            if (inst) inst.hide();
        });
    }
});

// Initial wiring on page load
$(document).ready(function () {
    // Initialize summary from existing DOM data
    const $first = $('.project-enumerated-statuses-view').first();
    const initialStatuses = $first.length ? ($first.data('current-statuses') || []) : [];
    const initialRemarks = $('.project-status-remarks-view .content').first().text() || '';
    renderStatuses(initialStatuses, initialRemarks);
    initStatusPopovers();
});



</script>
