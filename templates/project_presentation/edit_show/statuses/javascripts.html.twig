<script>

/*
  Ajax call function when user clicks on a status pill
*/
$(document).on('click', '.status-pill', function() {

    $(this).toggleClass('active');
    
    saveEnumStatusesAndRemarks();

});


/*
  Ajax call function when user type a free status remark (project progress details)
*/
let statusRemarksTimer = null;

$(document).on('input', '#status-remarks-textarea', function () {

    const $textarea = $(this);

    const newRemark = $textarea.val();

    // Clear previous timer
    clearTimeout(statusRemarksTimer);

    // Debounce: wait 800ms after the last keystroke before saving
    statusRemarksTimer = setTimeout(() => {
        saveEnumStatusesAndRemarks(newRemark);
    }, 800);
    
});


/*
  Actual ajax call (live save) when project statuses are updated
*/
function saveEnumStatusesAndRemarks() {

    const $pill = $(this);
    const $container = $('#project-statuses-editor');
    const updateUrl = $container.data('update-url');
    const remarks = $('#status-remarks-textarea').val();

    const $feedback = $('#remarks-feedback');
    $feedback.text('⟳ Sauvegarde...').removeClass('text-success text-danger d-none').addClass('text-muted');

    // Gather all active statuses
    const activeStatuses = $container.find('.status-pill.active').map(function() {
        return $(this).data('status');
    }).get();

    console.log(activeStatuses);

    // Send update to backend
    $.ajax({

        url: updateUrl,
        type: 'POST',
        data: JSON.stringify({ statuses: activeStatuses, remarks: remarks }),
        contentType: 'application/json',

        success: function (response) {

            console.log('Statuses saved:', response.enumStatuses);

            $(document).trigger('statuses:updated', [response.enumStatuses, response.statusRemarks]); // Sending an updated event to update view

            $feedback.text('✓ Enregistré').removeClass('text-muted').addClass('text-success');

            setTimeout(() => $feedback.addClass('d-none'), 1500);
        },

        error: function (xhr) {
            console.error('Error saving statuses:', xhr.responseText);
        }

    });

}



/*
  Statuses:updated Event listener to refresh UI
*/
$(document).on('statuses:updated', function (event, newStatuses, newRemarks) {
    renderStatuses(newStatuses, newRemarks);
});

// Re-render pills and remarks without external dependencies
function renderStatuses(newStatuses, newRemarks) {
    const $containers = $('.project-enumerated-statuses-view');
    if (!$containers.length) {
        return;
    }

    const catalog = $containers.first().data('catalog') || [];

    const activeItems = [];
    catalog.forEach(cat => {
        (cat.items || []).forEach(item => {
            if (newStatuses.includes(item.uniqueName)) {
                activeItems.push({
                    text: item.short_description_fr,
                    status: item.uniqueName,
                    title: item.description_fr,
                    color: item.bg_color,
                });
            }
        });
    });

    console.log(activeItems);
    
    // Re-render the pills inline across all containers (mobile + desktop)
    $containers.each(function () {
        const $container = $(this);
        $container.empty();
        if (!activeItems.length) {
            $container.append('<span class="text-muted">Aucun statut</span>');
        } else {
            activeItems.forEach(item => {
                const pill = $('<span>', {
                    class: 'status-pill-view px-3 py-2 rounded-pill text-dark fw-semibold',
                    'data-status': item.status,
                    title: item.title,
                    text: item.text,
                    css: { backgroundColor: item.color },
                });
                $container.append(pill);
            });
        }
    });

    const $remarkBox = $('.project-status-remarks-view .content');

    // Update remark text
    if ($remarkBox.length) {
        $remarkBox.text(newRemarks || '');
    }

    // Refresh popover content if present
    initStatusPopovers();
}

// Init or refresh popovers on all buttons
function initStatusPopovers() {
    $('.status-popover-btn').each(function () {
        const btn = this;
        if (!(window.bootstrap && bootstrap.Popover)) return;

        const contentHtml = document.querySelector('.project-statuses-view')?.outerHTML || '';
        const existing = bootstrap.Popover.getInstance(btn);
        if (existing) {
            existing.dispose();
        }
        new bootstrap.Popover(btn, {
            html: true,
            content: contentHtml,
            customClass: 'wide-popover',
            trigger: 'focus',
            sanitize: false,
        });
    });
}

// Initial wiring on page load
$(document).ready(function () {
    initStatusPopovers();
});



</script>
