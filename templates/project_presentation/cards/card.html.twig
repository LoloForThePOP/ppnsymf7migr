{#
  Project presentation card macro.
  Usage:
    {% from '_cards/project_presentation.html.twig' import project_card %}
    {{ project_card(presentation, { image: thumbnailUrl }) }}
#}

{% macro project_card(presentation, opts = {}) %}
    {# Defaults can be overridden when calling the macro #}
    {% set defaults = {
        link: presentation is defined and presentation.stringId is defined ? path('edit_show_project_presentation', {'stringId': presentation.stringId}) : null,
        linkTarget: null,
        image: presentation.extra.cacheThumbnailUrl ?? null,
        fetchImagesLink: null,
        showKeywords: true,
        showMeta: true,
        showViews: true,
        showCreator: false,
        showBookmark: true,
        bookmarkMode: 'add-only',
        likesCount: null,
        commentsCount: null,
        fallbackImageText: 'Aucune image'
    } %}
    {% set options = defaults|merge(opts) %}
    {% set imageUrl = options.image %}
    {% set ariaLabel = presentation.title ?? presentation.goal %}
    {% set fallbackSource = (presentation.title ?? presentation.goal ?? '')|trim %}
    {% set fallbackLetter = fallbackSource ? fallbackSource|slice(0, 1)|upper : '' %}
    {% set isAdminSession = is_granted('ROLE_ADMIN') or is_granted('ROLE_SUPER_ADMIN') %}
    {% set showEnrich = options.fetchImagesLink and not isAdminSession %}
    {% set showDelete = options.deleteLink is defined and options.deleteLink and not isAdminSession %}
    {% set canBookmark = options.showBookmark and presentation is defined and presentation.stringId is defined %}
    {% set bookmarkMode = options.bookmarkMode|default('add-only') %}
    {% set supportsBookmarkToggle = bookmarkMode == 'toggle' %}
    {% set bookmarkUrl = canBookmark
        ? (supportsBookmarkToggle
            ? path('ajax_bookmark_pp', { stringId: presentation.stringId })
            : path('ajax_bookmark_pp_add', { stringId: presentation.stringId })
        )
        : null
    %}
    {% set bookmarkLabelAdd = 'Ajouter aux marque-pages' %}
    {% set bookmarkLabelActive = supportsBookmarkToggle ? 'Retirer des marque-pages' : 'Déjà dans vos marque-pages' %}
    {% set isBookmarked = false %}
    {% if app.user and canBookmark and supportsBookmarkToggle %}
        {% if options.isBookmarked is defined and options.isBookmarked is not null %}
            {% set isBookmarked = options.isBookmarked %}
        {% elseif presentation.id is defined %}
            {% set isBookmarked = app.user.hasBookmarkedProjectId(presentation.id) %}
        {% else %}
            {% set isBookmarked = app.user.hasBookmarkedProject(presentation) %}
        {% endif %}
    {% elseif options.isBookmarked is defined and options.isBookmarked %}
        {% set isBookmarked = true %}
    {% endif %}

    {% set categoryTokens = [] %}
    {% if presentation.categories is defined %}
        {% for category in presentation.categories %}
            {% set token = category.uniqueName is defined ? category.uniqueName|trim|lower : '' %}
            {% if token and token not in categoryTokens %}
                {% set categoryTokens = categoryTokens|merge([token]) %}
            {% endif %}
        {% endfor %}
    {% endif %}
    {% set categoryData = categoryTokens|join(',') %}
    {% set keywordData = presentation.keywords|default('')|trim %}
    {% set eventUrl = presentation is defined and presentation.stringId is defined ? path('pp_event', {'stringId': presentation.stringId}) : '' %}

    <article
        class="project-card position-relative text-reset"
        {% if categoryData %}data-pp-categories="{{ categoryData }}"{% endif %}
        {% if keywordData %}data-pp-keywords="{{ keywordData }}"{% endif %}
        {% if presentation.stringId is defined %}data-pp-string-id="{{ presentation.stringId }}"{% endif %}
        {% if eventUrl %}data-pp-event-url="{{ eventUrl }}"{% endif %}
    >
        {% if options.link %}
            <a
                class="stretched-link" style="z-index: 40;"
                href="{{ options.link }}"
                {% if options.linkTarget %}target="{{ options.linkTarget }}"{% endif %}
                aria-label="{{ ariaLabel }}"
            ></a>
        {% endif %}

        {% if canBookmark %}
            {% if app.user %}
                <button
                    type="button"
                    class="project-card__bookmark js-ajax-bookmark-pp-card {{ isBookmarked ? 'isBookmarked' }}"
                    data-url="{{ bookmarkUrl }}"
                    data-token="{{ csrf_token('bookmark' ~ presentation.stringId) }}"
                    data-bookmark-mode="{{ supportsBookmarkToggle ? 'toggle' : 'add-only' }}"
                    data-label-add="{{ bookmarkLabelAdd }}"
                    data-label-active="{{ bookmarkLabelActive }}"
                    aria-label="{{ isBookmarked ? bookmarkLabelActive : bookmarkLabelAdd }}"
                    title="{{ isBookmarked ? bookmarkLabelActive : bookmarkLabelAdd }}"
                    {% if not supportsBookmarkToggle and isBookmarked %}disabled{% endif %}
                >
                    <svg class="bookmarkIcon notFilled" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M6 3.75A2.25 2.25 0 0 0 3.75 6v13.5c0 .6.68.95 1.17.6L12 15.95l7.08 4.15a.75.75 0 0 0 1.17-.6V6A2.25 2.25 0 0 0 18 3.75H6Zm0 1.5h12c.41 0 .75.34.75.75v12.2l-6.37-3.73a.75.75 0 0 0-.76 0l-6.37 3.73V6c0-.41.34-.75.75-.75Z" fill="currentColor"></path>
                    </svg>
                    <svg class="bookmarkIcon filled" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M6 3.75A2.25 2.25 0 0 0 3.75 6v13.5c0 .6.68.95 1.17.6L12 15.95l7.08 4.15a.75.75 0 0 0 1.17-.6V6A2.25 2.25 0 0 0 18 3.75H6Z" fill="currentColor"></path>
                    </svg>
                </button>
            {% else %}
                <a class="project-card__bookmark" href="{{ path('app_login') }}" aria-label="Se connecter pour enregistrer ce projet" title="Se connecter pour enregistrer ce projet">
                    <svg class="bookmarkIcon notFilled" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M6 3.75A2.25 2.25 0 0 0 3.75 6v13.5c0 .6.68.95 1.17.6L12 15.95l7.08 4.15a.75.75 0 0 0 1.17-.6V6A2.25 2.25 0 0 0 18 3.75H6Zm0 1.5h12c.41 0 .75.34.75.75v12.2l-6.37-3.73a.75.75 0 0 0-.76 0l-6.37 3.73V6c0-.41.34-.75.75-.75Z" fill="currentColor"></path>
                    </svg>
                </a>
            {% endif %}
        {% endif %}

        <div class="image-container{{ imageUrl ? ' has-image' : '' }}">
        {% if imageUrl %}
            <img src="{{ imageUrl }}" alt="{{ ariaLabel }}" loading="lazy">
        {% else %}
            <div class="project-card__fallback">
                {% if fallbackLetter %}
                    <span class="project-card__fallback-letter" aria-hidden="true">{{ fallbackLetter }}</span>
                {% else %}
                    <small class="project-card__fallback-text">{{ options.fallbackImageText }}</small>
                {% endif %}
            </div>
        {% endif %}
        </div>

        {% if showEnrich or showDelete %}
            <div class="admin-actions position-absolute top-0 end-0 p-2 d-flex gap-1" style="z-index: 50;">
                {% if showEnrich %}
                    <a class="btn btn-outline-primary btn-sm" href="{{ options.fetchImagesLink }}">Enrichir</a>
                {% endif %}
                {% if showDelete %}
                    <form method="post" action="{{ options.deleteLink }}" onsubmit="return confirm('Supprimer définitivement ce projet ?');">
                        <button type="submit" class="btn btn-outline-danger btn-sm">Supprimer</button>
                    </form>
                {% endif %}
            </div>
        {% endif %}

        <div class="goal-container">
            {% set goalText = presentation.goal|default('') %}
            <div class="goal">{{ goalText ? goalText|truncate(57) : '' }}</div> 
            {% if presentation.title %}
                {% set titleText = presentation.title %}
                <div class="title">{{ titleText ? titleText|truncate(60) : '' }}</div>
            {% endif %}
        </div>

        {# {% if options.showKeywords and presentation.keywords %}
            <div class="keywords px-3 pb-2">{{ presentation.keywords }}</div>
        {% endif %} #}

        {% if options.showMeta %}
            <div class="other-info-container">
                <div class="stats">
                    <span class="stat-chunk">
                        <img class="pp-card-stat-icon-image icon-themed" src="{{ asset('thumb_up.svg', 'misc')}}" alt="thumb-up icon">
                        {% set likes = options.likesCount is not null ? options.likesCount : presentation.likes|default([])|length %}
                        {{ likes }}
                    </span>
                    <span class="stat-chunk">
                        <img class="pp-card-stat-icon-image icon-themed" src="{{ asset('comment.svg', 'misc')}}" alt="comment icon">
                        {% set comments = options.commentsCount is not null ? options.commentsCount : presentation.comments|default([])|length %}
                        {{ comments }}
                    </span>
                    {% if options.showViews %}
                        {% set views = presentation.extra.viewsCount ?? 0 %}
                        <span class="stat-chunk">
                            <img class="pp-card-stat-icon-image icon-themed" src="{{ asset('eye.svg', 'misc')}}" alt="eye icon">
                            {{ views }}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </article>
{% endmacro %}
