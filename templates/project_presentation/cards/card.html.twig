{#
  Project presentation card macro.
  Usage:
    {% from '_cards/project_presentation.html.twig' import project_card %}
    {{ project_card(presentation, { image: thumbnailUrl }) }}
#}

{% macro project_card(presentation, opts = {}) %}
    {# Defaults can be overridden when calling the macro #}
    {% set defaults = {
        link: presentation is defined and presentation.stringId is defined ? path('edit_show_project_presentation', {'stringId': presentation.stringId}) : null,
        linkTarget: null,
        image: presentation.extra.cacheThumbnailUrl ?? null,
        fetchImagesLink: null,
        showKeywords: true,
        showMeta: true,
        showViews: true,
        showCreator: false,
        likesCount: null,
        commentsCount: null,
        fallbackImageText: 'Aucune image'
    } %}
    {% set options = defaults|merge(opts) %}
    {% set imageUrl = options.image %}
    {% set ariaLabel = presentation.title ?? presentation.goal %}
    {% set isAdminSession = is_granted('ROLE_ADMIN') or is_granted('ROLE_SUPER_ADMIN') %}
    {% set showEnrich = options.fetchImagesLink and not isAdminSession %}
    {% set showDelete = options.deleteLink is defined and options.deleteLink and not isAdminSession %}

    <article class="project-card position-relative text-reset">
        {% if options.link %}
            <a
                class="stretched-link" style="z-index: 40;"
                href="{{ options.link }}"
                {% if options.linkTarget %}target="{{ options.linkTarget }}"{% endif %}
                aria-label="{{ ariaLabel }}"
            ></a>
        {% endif %}

        <div class="image-container">
        {% if imageUrl %}
            <img src="{{ imageUrl }}" alt="{{ ariaLabel }}" loading="lazy">
        {% else %}
            <div class="h-100 w-100 d-flex align-items-center justify-content-center bg-light text-muted rounded">
                <small>{{ options.fallbackImageText }}</small>
            </div>
        {% endif %}
        </div>

        {% if showEnrich or showDelete %}
            <div class="admin-actions position-absolute top-0 end-0 p-2 d-flex gap-1" style="z-index: 50;">
                {% if showEnrich %}
                    <a class="btn btn-outline-primary btn-sm" href="{{ options.fetchImagesLink }}">Enrichir</a>
                {% endif %}
                {% if showDelete %}
                    <form method="post" action="{{ options.deleteLink }}" onsubmit="return confirm('Supprimer dÃ©finitivement ce projet ?');">
                        <button type="submit" class="btn btn-outline-danger btn-sm">Supprimer</button>
                    </form>
                {% endif %}
            </div>
        {% endif %}

        <div class="goal-container">
            {% set goalText = presentation.goal|default('') %}
            <div class="goal">{{ goalText ? goalText|truncate(81) : '' }}</div> 
            {% if presentation.title %}
                {% set titleText = presentation.title %}
                <div class="title">{{ titleText ? titleText|truncate(60) : '' }}</div>
            {% endif %}
        </div>

        {# {% if options.showKeywords and presentation.keywords %}
            <div class="keywords px-3 pb-2">{{ presentation.keywords }}</div>
        {% endif %} #}

        {% if options.showMeta %}
            <div class="other-info-container">
                <div class="stats">
                    <span class="stat-chunk">
                        <img class="pp-card-icon" src="{{ asset('thumb_up_dark.svg', 'misc')}}" alt="thumb-up icon">
                        {% set likes = options.likesCount is not null ? options.likesCount : presentation.likes|default([])|length %}
                        {{ likes }}
                    </span>
                    <span class="stat-chunk">
                        <img class="pp-card-icon" src="{{ asset('comment.svg', 'misc')}}" alt="comment icon">
                        {% set comments = options.commentsCount is not null ? options.commentsCount : presentation.comments|default([])|length %}
                        {{ comments }}
                    </span>
                    {% if options.showViews %}
                        {% set views = presentation.extra.viewsCount ?? 0 %}
                        <span class="stat-chunk">
                            <img class="pp-card-icon" src="{{ asset('eye.svg', 'misc')}}" alt="eye icon">
                            {{ views }}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </article>
{% endmacro %}
