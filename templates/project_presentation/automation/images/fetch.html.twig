{% extends 'base.html.twig' %}

{% block title %}Images pour {{ project.title ?? project.goal }}{% endblock %}

{% block body %}
    <div class="container my-4" id="image-fetch-root">
        <h1 class="h4 mb-3">Images candidates</h1>

        <p class="text-muted">
            Source : <a href="{{ sourceUrl ?: 'Aucune source renseignée (ing_source_url)' }}" target="_blank" rel="noopener noreferrer nofollow">{{ sourceUrl ?: 'Aucune source renseignée (ing_source_url)' }}</a> 
        </p>

        {% if is_granted('ROLE_ADMIN') %}
            <div class="d-flex gap-2 mb-3">
                <form method="post" action="{{ path('project_delete_from_images', {'stringId': project.stringId}) }}" onsubmit="return confirm('Supprimer définitivement ce projet ?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('project_delete_from_images') }}">
                    <button type="submit" class="btn btn-danger btn-sm">Supprimer ce projet</button>
                </form>
                <a class="btn btn-outline-secondary btn-sm" href="{{ path('project_fetch_images', {'stringId': project.stringId}) }}">Rafraîchir</a>
                <a class="btn btn-outline-primary btn-sm" href="{{ path('edit_show_project_presentation', {'stringId': project.stringId}) }}">Voir le projet</a>
            </div>
        {% endif %}

        <div id="candidates-wrapper">
            {% include 'project_presentation/automation/images/_candidates.html.twig' %}
        </div>

        <div class="card my-3">
            <div class="card-body">
                <form method="post" action="{{ path('project_fetch_images', {'stringId': project.stringId}) }}" class="ajaxable">
                    <input type="hidden" name="_token" value="{{ csrf_token('project_fetch_images') }}">
                    <div class="mb-2">
                        <label for="page_html" class="form-label">Coller le code source de la page pour extraire les images</label>
                        <textarea class="form-control" id="page_html" name="page_html" rows="6" placeholder="&lt;html&gt;..." spellcheck="false">{{ pageHtml|default('') }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Extraire les images</button>
                </form>
            </div>
        </div>

        {% if links is defined and links %}
            <div class="card my-3">
                <div class="card-body">
                <form method="post" action="{{ path('project_image_add_links', {'stringId': project.stringId}) }}" class="ajaxable">
                    <input type="hidden" name="_token" value="{{ csrf_token('project_image_add_links') }}">
                    <h2 class="h6 mb-2">Liens détectés</h2>
                        <div class="small text-muted mb-2">Sélectionner les liens à ajouter comme sites web du projet</div>
                        <div class="row g-2">
                            {% for link in links %}
                                <div class="col-12 col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="links[]" id="link_{{ loop.index }}" value="{{ link }}">
                                        <label class="form-check-label text-break" for="link_{{ loop.index }}">{{ link }}</label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-outline-primary btn-sm">Ajouter les liens sélectionnés</button>
                        </div>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.getElementById('candidates-wrapper');
            const flashContainer = document.createElement('div');
            flashContainer.className = 'position-fixed top-0 end-0 p-3';
            flashContainer.style.zIndex = 2000;
            document.body.appendChild(flashContainer);

            const showFlash = (message, type = 'info') => {
                const el = document.createElement('div');
                el.className = `alert alert-${type} alert-dismissible fade show`;
                el.textContent = message;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-close';
                btn.setAttribute('data-bs-dismiss', 'alert');
                el.appendChild(btn);
                flashContainer.appendChild(el);
                setTimeout(() => {
                    el.classList.remove('show');
                    el.remove();
                }, 3000);
            };

            const bindAjaxForms = () => {
                document.querySelectorAll('form.ajaxable').forEach((form) => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const fd = new FormData(form);
                        try {
                            const res = await fetch(form.action, {
                                method: form.method || 'POST',
                                body: fd,
                                headers: {'X-Requested-With': 'XMLHttpRequest'},
                            });
                            if (!res.ok) {
                                showFlash('Action échouée', 'danger');
                                return;
                            }
                            const html = await res.text();
                            wrapper.innerHTML = html;
                            bindAjaxForms();
                            showFlash('Mise à jour effectuée', 'success');
                        } catch (err) {
                            console.error(err);
                            showFlash('Erreur réseau', 'danger');
                        }
                    });
                });
            };

            bindAjaxForms();
        });
    </script>
{% endblock %}
