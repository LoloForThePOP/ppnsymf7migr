{# User can display projects by categories (tabs navigation) #}
{# Ex: user can select the "history" tab (displaying some projects about history); the "environment" tab; and so on #}

{% set tabDefinitions = [
    { id: 'v-all', label: 'Tous les projets', category: 'all', tabindex: 0 },
    { id: 'v-history', label: 'Histoire', category: 'history', tabindex: 1 },
    { id: 'v-space', label: 'Aéronautique', category: 'space', tabindex: 2 },
    { id: 'v-numeric', label: 'Numérique', category: 'software', tabindex: 3 },
    { id: 'v-inform', label: 'Informer - Apprendre', category: 'inform', tabindex: 4 },
    { id: 'v-environment', label: 'Environnement', category: 'environment', tabindex: 5 },
    { id: 'v-humane', label: 'Solidarité', category: 'humane', tabindex: 6 },
    { id: 'v-db', label: 'Bases de Données', category: 'data', tabindex: 7 }
] %}

<div class="project-by-categories">

    {# Tabs Navigation Buttons by project Categories #}

    <div class="nav" id="v-tab" role="tablist" aria-orientation="vertical">
        {% for tab in tabDefinitions %}
            <button
                class="nav-link"
                id="{{ tab.id }}-tab"
                data-bs-target="#{{ tab.id }}"
                data-tab-category="{{ tab.category }}"
                type="button"
                role="tab"
                aria-controls="{{ tab.id }}"
                aria-selected="false"
            >
                {{ tab.label }}
            </button>
        {% endfor %}

    </div>

    {# Tabs Contents loaded async on demand (including first tab). #}

    <div class="tab-content" id="v-tabContent">
        {% for tab in tabDefinitions %}
            <div
                class="tab-pane"
                id="{{ tab.id }}"
                role="tabpanel"
                tabindex="{{ tab.tabindex }}"
                data-tab-category="{{ tab.category }}"
                data-tab-loaded="0"
                aria-labelledby="{{ tab.id }}-tab"
            >
                <div class="small text-muted py-2 px-1">Sélectionnez une catégorie pour charger les projets.</div>
            </div>
        {% endfor %}
    </div>

</div>

<script>
    (function () {
        var root = document.querySelector('.project-by-categories');
        if (!root) {
            return;
        }

        var routeTemplate = '{{ path('category_tab', {category: '__CATEGORY__'})|e('js') }}';
        var tabLinks = root.querySelectorAll('.nav-link[data-bs-target]');
        var tabContent = root.querySelector('.tab-content');
        var activeRequestByPane = new WeakMap();

        function setSelectedLink(activeLink) {
            tabLinks.forEach(function (link) {
                var isActive = link === activeLink;
                link.classList.toggle('selected', isActive);
                link.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
        }

        function setActivePane(activePane) {
            var panes = root.querySelectorAll('.tab-pane');
            panes.forEach(function (pane) {
                var isActivePane = pane === activePane;
                if (!isActivePane) {
                    pane.classList.remove('show');
                    pane.classList.remove('active');
                    return;
                }

                pane.classList.add('active');
                if (typeof window.requestAnimationFrame === 'function') {
                    window.requestAnimationFrame(function () {
                        pane.classList.add('show');
                    });
                    return;
                }
                pane.classList.add('show');
            });
        }

        function setSelectedTab(activeLink, activePane) {
            setSelectedLink(activeLink);
            setActivePane(activePane);
        }

        function resolvePane(link) {
            if (!link) {
                return null;
            }
            var target = link.getAttribute('data-bs-target') || '';
            if (!target || target.charAt(0) !== '#') {
                return null;
            }
            return root.querySelector(target);
        }

        function lockTabContentHeight() {
            if (!tabContent) {
                return function () {};
            }

            var activePane = root.querySelector('.tab-pane.show.active');
            var lockHeight = activePane ? activePane.offsetHeight : tabContent.offsetHeight;
            if (lockHeight > 0) {
                tabContent.style.minHeight = lockHeight + 'px';
            }

            return function release() {
                if (!tabContent) {
                    return;
                }
                if (typeof window.requestAnimationFrame === 'function') {
                    window.requestAnimationFrame(function () {
                        tabContent.style.minHeight = '';
                    });
                    return;
                }
                tabContent.style.minHeight = '';
            };
        }

        function refreshPaneLayout(pane) {
            if (!pane || typeof window.initShowMoreLess !== 'function') {
                return;
            }

            window.initShowMoreLess(pane);
            if (typeof window.requestAnimationFrame === 'function') {
                window.requestAnimationFrame(function () {
                    window.initShowMoreLess(pane);
                });
            }
        }

        function loadPane(pane, done) {
            if (!pane) {
                if (typeof done === 'function') {
                    done();
                }
                return;
            }
            var status = pane.getAttribute('data-tab-loaded');
            if (status === '1' || status === 'loading') {
                if (typeof done === 'function') {
                    done();
                }
                return;
            }

            var category = pane.getAttribute('data-tab-category') || '';
            if (!category) {
                if (typeof done === 'function') {
                    done();
                }
                return;
            }

            var url = routeTemplate.replace('__CATEGORY__', encodeURIComponent(category));
            pane.setAttribute('data-tab-loaded', 'loading');
            pane.innerHTML = '<div class="small text-muted py-2 px-1">Chargement...</div>';
            var requestToken = Date.now().toString(36) + Math.random().toString(36).slice(2);
            activeRequestByPane.set(pane, requestToken);

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('Unable to load tab content.');
                    }
                    return response.text();
                })
                .then(function (html) {
                    if (activeRequestByPane.get(pane) !== requestToken) {
                        return;
                    }
                    pane.innerHTML = html;
                    pane.setAttribute('data-tab-loaded', '1');
                    refreshPaneLayout(pane);
                    if (typeof done === 'function') {
                        done();
                    }
                })
                .catch(function () {
                    if (activeRequestByPane.get(pane) !== requestToken) {
                        return;
                    }
                    pane.innerHTML = '<div class="small text-danger py-2 px-1">Impossible de charger cette catégorie pour le moment.</div>';
                    pane.setAttribute('data-tab-loaded', '0');
                    if (typeof done === 'function') {
                        done();
                    }
                });
        }

        tabLinks.forEach(function (link) {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                var pane = resolvePane(link);
                if (!pane) {
                    return;
                }

                var status = pane.getAttribute('data-tab-loaded');
                var activePane = root.querySelector('.tab-pane.show.active');
                var releaseHeight = lockTabContentHeight();

                if (status === '1') {
                    setSelectedTab(link, pane);
                    refreshPaneLayout(pane);
                    releaseHeight();
                    return;
                }

                if (!activePane || activePane === pane) {
                    setSelectedTab(link, pane);
                    loadPane(pane, releaseHeight);
                    return;
                }

                // Keep current pane visible while loading the next one to avoid layout flashing.
                setSelectedLink(link);
                loadPane(pane, function () {
                    setSelectedTab(link, pane);
                    refreshPaneLayout(pane);
                    releaseHeight();
                });
            });
        });
    })();

</script>
