{#

To use this template, we need access to those variables :

    - the commented entity type (ex: a projectPresentation, an article, etc)
    - the commented entity id
    - the comments from the commented entity

#}

{% import 'comment/_macro.html.twig' as commentMacros %}


{% set countCommentedEntityComments = commentedEntityComments | length %}

{% set manageAllowed = commentedEntityType == 'projectPresentation' and (userPresenter | default(false) or userAdmin | default(false)) %}
{% set manageModalId = 'manage-comments-modal-' ~ commentedEntityType ~ '-' ~ commentedEntityId %}
{% set commentFormKey = manageAllowed ? 'comment-form-' ~ commentedEntityType ~ '-' ~ commentedEntityId : '' %}

{% if manageAllowed %}
    <div class="pp-edition-mode pp-comments-compact">
        <div class="pp-struct-title-container">
            <h3 class="pp-struct-title">
                <span
                    class="pp-struct-icon"
                    style="--pp-struct-icon-url: url('{{ asset('dialog.svg', 'misc') }}');"
                    role="img"
                    aria-label="Commentaires"
                ></span>
                <span class="me-2">Gérer les commentaires</span>
            </h3>
        </div>
        <button
            type="button"
            class="pp-comments-overlay"
            data-bs-toggle="modal"
            data-bs-target="#{{ manageModalId }}"
            aria-label="Gérer les commentaires"
        ></button>
    </div>
{% endif %}

<div class="commentSectionHeader d-flex align-items-center justify-content-between mb-3 pp-consultation-mode">

    <h3 class="commentSectionTitle mb-0">{{countCommentedEntityComments}} Commentaire{% if countCommentedEntityComments > 1 %}s{% endif %} </h3>

    {% if manageAllowed %}

        <button
            type="button"
            class="pp-edition-mode btn btn-light btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#{{ manageModalId }}"
        >Gérer</button>

    {% endif %}

</div>

{% if manageAllowed %}

    {% embed "utilities/modal_skeleton.html.twig" with {'modal_id': manageModalId, 'modal_size': "modal-lg modal-dialog-scrollable"} %}

        {% block modalTitle %}
            <h5 class="modal-title">Gérer les commentaires ({{ countCommentedEntityComments }})</h5>
        {% endblock %}

        {% block modalBody %}
            {% import 'comment/_macro.html.twig' as commentMacros %}

            <div class="mb-3" data-comment-form-slot="{{ commentFormKey }}" data-slot="modal"></div>

            {% if countCommentedEntityComments == 0 %}

                <p class="text-muted mb-0">Aucun commentaire pour le moment.</p>

            {% else %}

                {% for comment in commentedEntityComments | reverse %}

                    {% if comment.getParent is null %} {# we display only parent comments (and then its potential child) #}

                        <article class="threadContainer">

                            {{ commentMacros.oneCommentContainer(
                                commentedEntityType=commentedEntityType,
                                commentedEntityId=commentedEntityId,
                                comment=comment,
                                parentCommentId=comment.id,
                                showEdit=false,
                                showReport=true,
                                idPrefix='comment-manage'
                            ) }}

                            {% if comment.replies | length > 0 %}

                                <div class="commentRepliesContainer">

                                    {% for subComment in comment.replies %}

                                        {{ commentMacros.oneCommentContainer(
                                            commentedEntityType=commentedEntityType,
                                            commentedEntityId=commentedEntityId,
                                            comment=subComment,
                                            parentCommentId=comment.id,
                                            showEdit=false,
                                            showReport=true,
                                            idPrefix='comment-manage'
                                        ) }}

                                    {% endfor %}

                                </div>

                            {% endif %}

                        </article>

                    {% endif %}

                {% endfor %}

            {% endif %}

        {% endblock %}

    {% endembed %}

{% endif %}

{% if manageAllowed %}

    <div class="pp-consultation-mode">

        <div data-comment-form-slot="{{ commentFormKey }}" data-slot="inline">

            <div class="comment-form-wrapper" data-comment-form-wrapper="{{ commentFormKey }}">

                {{ commentMacros.commentForm(commentedEntityType, commentedEntityId) }}

            </div>

        </div>

{% else %}

    {{ commentMacros.commentForm(commentedEntityType, commentedEntityId) }}

{% endif %}

{# Comments display loop #}

{% for comment in commentedEntityComments | reverse %}

    {% if comment.getParent is null %} {# we display only parent comments (and then its potential child) #}

        <!-- thread container -->

        <article class="threadContainer">

            {{ commentMacros.oneCommentContainer(commentedEntityType, commentedEntityId, comment, comment.id) }}

            <!-- Maybe Some Comment Childs -->

            {% if comment.replies | length > 0 %}

                <!-- Child Comments container with Indentation -->

                <div class="commentRepliesContainer">

                    {% for subComment in comment.replies %}

                        {{ commentMacros.oneCommentContainer(commentedEntityType, commentedEntityId, subComment, comment.id) }}

                    {% endfor %}
                
                </div>
                <!-- End Of Comment Child Comments container -->

            {% endif %}

            <!-- End of Comment Section -->

        </article>

    {% endif %}

{% endfor %}

{% if manageAllowed %}
    </div>
{% endif %}
