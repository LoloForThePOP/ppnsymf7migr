

{# new comment pattern #}
<script>

    const newCommentPattern = ({ newCommentContent, newCommentUrl }) => `

        <div class="liveNewComment">

            <div>Commentaire ajouté ✅</div>

            <div>

                ${newCommentContent}
            
            </div>

            <div>

                <a href="${newCommentUrl}" class="">Modifier</a>
            
            </div>

        </div>
    `;
    
    $(document).ready(function(){

        const commentCsrfToken = "{{ csrf_token('comment_mutation') }}";

        // creating a reply comment form (in addition to the create new parent comment form)
        var $baseForm = $(".commentForm:first");
        if ($baseForm.length) {
            var replyForm = $baseForm.clone().addClass("replyCommentForm");
            $baseForm.after(replyForm);
            $(".replyCommentForm").hide();
        }

        var movePresentationCommentForm = function () {
            var $ppContainer = $(".pp-container");
            if ($ppContainer.length === 0) {
                return;
            }

            var isEditionMode = $ppContainer.hasClass("in-edition-mode");

            $("[data-comment-form-wrapper]").each(function () {
                var key = $(this).data("comment-form-wrapper");
                if (!key) {
                    return;
                }
                var targetSlot = '[data-comment-form-slot="' + key + '"][data-slot="' + (isEditionMode ? "modal" : "inline") + '"]';
                var $slot = $(targetSlot).first();
                if ($slot.length) {
                    $(this).appendTo($slot);
                }
            });
        };

        movePresentationCommentForm();

        $("#pp-switch-edit-consult-mode").on("click", function () {
            setTimeout(movePresentationCommentForm, 0);
        });

        // when user click on reply to a comment button, we're placing the reply comment form where appropriate
        $(document).on("click", ".replyCommentButton", function( event ){

            $(".replyCommentForm").hide();

            $(this).parent().after( $(".replyCommentForm:first").show()); // insert reply comment form after the message to answer
            
            $(".replyCommentForm textarea").val('').focus();
            $(".replyCommentForm").removeClass('is-filled');

            $(".replyCommentForm").attr("data-commented-entity-type", $(this).attr("data-commented-entity-type")) //for data base storage.

            $(".replyCommentForm").attr("data-commented-entity-id", $(this).attr("data-commented-entity-id")) // for data base storage.

            $(".replyCommentForm").attr("data-parent-comment-id", $(this).attr("data-parent-comment-id")) // store parent comment id for data base storage.

            $(".replyCommentForm").attr("data-comment-id", $(this).attr("data-comment-id")) // store replied comment id to notify replied comment user.

        });

        // Change send button state when input changed
        $(document).on('input propertychange', '.commentForm textarea', function() {

            var $form = $(this).closest('.commentForm');
            var hasContent = this.value.trim().length > 0;

            $form.toggleClass('is-filled', hasContent);

            if (document.documentElement.getAttribute('data-theme-variant') === 'custom') {
                $("button", $form).css('background-color', '');
                return;
            }

            var buttonColor = hasContent ? "#ddf5c4" : "#ecf0f1";
            $("button", $form).css('background-color', buttonColor);

        });

        
        

        // submitting a comment   
        $(document).on("submit", ".commentForm", function( event ){

            event.preventDefault();

            var commentContent = $('textarea', this).val();
            var parentCommentId = $(this).attr("data-parent-comment-id"); // or null
            var repliedCommentId = $(this).attr("data-comment-id"); // or null

            var formTimeLoaded = $('.formTimeLoaded', this).text();
            var hnyPt = $('.hnyPt', this).val();

            var commentedEntityId = $(this).attr("data-commented-entity-id");
            var commentedEntityType = $(this).attr("data-commented-entity-type");


            $("button[type='submit']", $(this)).append('<div class="loader ms-2"></div>');

            var $t = $(this);

            $.ajax({  

              url: "{{path('ajax_create_comment')}}",
              type: 'POST',   
              dataType: 'json',
              data: {
            
                    "commentedEntityType": commentedEntityType,
                    "commentedEntityId": commentedEntityId,        
                    
                    "commentContent": commentContent,
                    "parentCommentId": parentCommentId,
                    "repliedCommentId": repliedCommentId,


                    "formTimeLoaded": formTimeLoaded,
                    "hnyPt": hnyPt,
                    "_token": commentCsrfToken,
              },
  
              async: true,  
              
              success: function(data, status) {
                
                $( ".errors", $t.closest(".oneCommentContainer")).text("");
                $( ".replyCommentButton", $t.closest(".oneCommentContainer")).remove();

                $(".loader").remove();
                console.log(data);

                $t.hide(); // hiding comment form

                $t.after([
                    { newCommentContent: commentContent, newCommentUrl: data.newCommentEditionUrl },
                ].map(newCommentPattern)); // we hydrate javascript new comment pattern

                if (commentedEntityType === 'news') {
                    var $trigger = $('.news-comments-trigger[data-news-id="' + commentedEntityId + '"]');
                    if ($trigger.length) {
                        var count = parseInt($trigger.attr('data-comments-count'), 10) || 0;
                        count += 1;
                        $trigger.attr('data-comments-count', count);
                        $('.news-comments-count', $trigger).text(count);
                    }
                }

              },  
  
                error : function(xhr, textStatus, errorThrown) {

                    $(".loader").remove();

                    console.log(errorThrown);
                    
                    $( ".errors", $t.closest(".oneCommentContainer")).addClass("text-danger").text(xhr.responseJSON.error);

                    
                    //console.log(xhr.responseJSON);
                }  
  
            });
    

        });

        // Remove a Comment

        $(document).on('click', '.js-remove-comment', function (){

            var commentId = $(this).attr("data-comment-id");

            if (confirm("Confirmez-vous retirer ce commentaire ainsi que ses réponses possibles ?"))
            { 

                $(this).html('<div class="loader"></div>');

                var $t = $(this);
                
                $.ajax({  

                    url: "{{path('ajax_remove_comment') }}",
                    type:       'POST',   
                    dataType:   'json',
                    data: {
                        "commentId": commentId,
                        "_token": commentCsrfToken,
                    },

                    async: true,  

                    success: function(data, status) {

                        //case comment might have child : we delete parent and potential childs
                        var $containers = $('.oneCommentContainer[data-comment-id="' + commentId + '"]');

                        $containers.each(function() {
                            var $container = $(this);

                            if ($container.parent(".threadContainer").length) {
                                $container.closest(".threadContainer").remove();
                            } else { // we delete only one comment
                                $container.remove();
                            }
                        });
                    
                    },  

                    error : function(xhr, textStatus, errorThrown) {  
                        // alert('Ajax request failed.');  
                    }  
                }); 
                    
            }


        });

    });

</script>
